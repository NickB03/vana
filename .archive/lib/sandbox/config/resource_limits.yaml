# VANA Sandbox Resource Limits Configuration
# Defines resource constraints for secure code execution

# Default resource limits applied to all executions
default_limits:
  # Execution constraints
  max_execution_time: 30          # Maximum execution time in seconds
  max_idle_time: 10               # Maximum idle time before termination

  # Memory constraints
  max_memory_mb: 512              # Maximum memory usage in MB
  max_swap_mb: 0                  # Disable swap usage

  # CPU constraints
  max_cpu_cores: 1                # Maximum CPU cores
  max_cpu_percent: 80             # Maximum CPU usage percentage
  cpu_quota: 100000               # CPU quota in microseconds (100ms)
  cpu_period: 100000              # CPU period in microseconds (100ms)

  # Disk I/O constraints
  max_disk_read_mb: 100           # Maximum disk read in MB
  max_disk_write_mb: 50           # Maximum disk write in MB
  max_disk_iops: 1000             # Maximum disk I/O operations per second

  # Network constraints (disabled for security)
  max_network_sent_mb: 0          # Maximum network sent in MB (0 = disabled)
  max_network_recv_mb: 0          # Maximum network received in MB (0 = disabled)
  max_network_connections: 0      # Maximum network connections (0 = disabled)

  # Process constraints
  max_processes: 10               # Maximum number of processes
  max_threads: 20                 # Maximum number of threads
  max_open_files: 100             # Maximum number of open files
  max_file_descriptors: 200       # Maximum file descriptors

  # File system constraints
  max_file_size_mb: 10            # Maximum individual file size in MB
  max_total_files: 1000           # Maximum total number of files
  max_directory_depth: 10         # Maximum directory nesting depth
  workspace_size_mb: 100          # Maximum workspace size in MB

# Language-specific resource limits
language_limits:
  python:
    max_execution_time: 45        # Python can be slower for complex operations
    max_memory_mb: 768            # More memory for data science operations
    max_processes: 5              # Limit multiprocessing
    max_open_files: 50            # Limit file operations

    # Python-specific constraints
    max_import_depth: 10          # Maximum import nesting
    max_recursion_depth: 1000     # Maximum recursion depth
    max_string_length: 1000000    # Maximum string length (1MB)
    max_list_length: 100000       # Maximum list length
    max_dict_size: 10000          # Maximum dictionary size

  javascript:
    max_execution_time: 30        # Standard timeout for JS
    max_memory_mb: 512            # Standard memory limit
    max_processes: 3              # Limit child processes
    max_open_files: 30            # Limit file operations

    # JavaScript-specific constraints
    max_call_stack: 1000          # Maximum call stack depth
    max_object_keys: 10000        # Maximum object keys
    max_array_length: 100000      # Maximum array length
    max_string_length: 1000000    # Maximum string length

  shell:
    max_execution_time: 20        # Shorter timeout for shell scripts
    max_memory_mb: 256            # Less memory for shell operations
    max_processes: 3              # Limit subprocess creation
    max_open_files: 20            # Limit file operations

    # Shell-specific constraints
    max_command_length: 1000      # Maximum command length
    max_pipe_depth: 5             # Maximum pipe nesting
    max_variables: 100            # Maximum environment variables
    max_aliases: 50               # Maximum command aliases

# Container resource limits
container_limits:
  # Memory limits
  memory: "512m"                  # Container memory limit
  memory_swap: "512m"             # Container memory + swap limit
  memory_swappiness: 0            # Disable swapping

  # CPU limits
  cpus: "1.0"                     # CPU limit (1 core)
  cpu_shares: 1024                # CPU shares (relative weight)

  # I/O limits
  blkio_weight: 500               # Block I/O weight
  device_read_bps: "10mb"         # Device read bandwidth limit
  device_write_bps: "5mb"         # Device write bandwidth limit
  device_read_iops: 1000          # Device read IOPS limit
  device_write_iops: 500          # Device write IOPS limit

  # Process limits
  pids_limit: 100                 # Maximum PIDs in container

  # Network limits (disabled)
  network_mode: "none"            # Disable network access

  # Security limits
  ulimits:
    nofile:                       # File descriptor limits
      soft: 100
      hard: 200
    nproc:                        # Process limits
      soft: 10
      hard: 20
    fsize:                        # File size limits
      soft: 10485760              # 10MB
      hard: 10485760              # 10MB
    cpu:                          # CPU time limits
      soft: 30                    # 30 seconds
      hard: 45                    # 45 seconds
    data:                         # Data segment limits
      soft: 536870912             # 512MB
      hard: 536870912             # 512MB
    stack:                        # Stack size limits
      soft: 8388608               # 8MB
      hard: 8388608               # 8MB
    rss:                          # Resident set size limits
      soft: 536870912             # 512MB
      hard: 536870912             # 512MB

# Monitoring configuration
monitoring:
  # Monitoring intervals
  resource_check_interval: 0.1    # Check resources every 100ms
  log_interval: 1.0               # Log metrics every second

  # Alert thresholds
  memory_warning_percent: 80      # Warn at 80% memory usage
  cpu_warning_percent: 70         # Warn at 70% CPU usage
  disk_warning_percent: 80        # Warn at 80% disk usage

  # Enforcement actions
  terminate_on_limit: true        # Terminate process when limits exceeded
  kill_timeout: 5                 # Seconds to wait before force kill
  cleanup_timeout: 10             # Seconds to wait for cleanup

# Security enforcement
security:
  # Filesystem restrictions
  read_only_filesystem: true      # Make filesystem read-only
  no_new_privileges: true         # Prevent privilege escalation

  # Capability restrictions
  drop_capabilities:
    - ALL                         # Drop all Linux capabilities

  # Seccomp profile
  seccomp_profile: "default"      # Use default seccomp profile

  # AppArmor profile
  apparmor_profile: "docker-default"  # Use default AppArmor profile

  # User namespace
  user_namespace: true            # Enable user namespace isolation

  # Mount restrictions
  tmpfs_mounts:
    /tmp: "size=100m,noexec"      # Temporary filesystem
    /var/tmp: "size=50m,noexec"   # Variable temporary filesystem

  # Environment restrictions
  env_whitelist:                  # Allowed environment variables
    - PATH
    - HOME
    - USER
    - SHELL
    - LANG
    - LC_ALL
    - TZ
    - PYTHONPATH
    - NODE_PATH

  # Signal restrictions
  blocked_signals:                # Signals that cannot be sent
    - SIGKILL
    - SIGSTOP
    - SIGCONT
