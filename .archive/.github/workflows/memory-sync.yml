name: Memory System Sync
on:
  push:
    branches: [main, develop]
  pull_request:
    merged: true
  workflow_dispatch:
    inputs:
      sync_type:
        description: 'Type of memory sync'
        required: true
        default: 'incremental'
        type: choice
        options:
        - incremental
        - full_rebuild
        - cleanup

jobs:
  memory-sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python 3.13
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'
          
      - name: Install dependencies
        run: |
          pip install google-cloud-aiplatform google-cloud-storage
          
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          
      - name: Extract Memory Context
        run: |
          python scripts/extract_memory_context.py \
            --source .claude/ \
            --output memory-export.json \
            --include-git-history \
            --format vertex-ai
            
      - name: Sync to Vertex AI Vector Store
        run: |
          python scripts/sync_to_vertex.py \
            --input memory-export.json \
            --index-name vana-memory-index \
            --sync-type ${{ github.event.inputs.sync_type || 'incremental' }}
            
      - name: Cleanup Outdated Entries
        run: |
          python scripts/memory_cleanup.py \
            --max-age-days 30 \
            --remove-deprecated \
            --consolidate-duplicates
            
      - name: Update Memory Health Status
        run: |
          python scripts/update_memory_health.py \
            --commit-sha ${{ github.sha }} \
            --sync-status success