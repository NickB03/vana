# Coverage Management System

## Overview
The Vana project now includes a comprehensive coverage management system to handle the accumulation of `.coverage` files generated by pytest. This system provides automated archiving, cleanup, reporting, and history tracking.

## Components

### 1. Coverage Management Script
Location: `scripts/manage_coverage.py`

A Python script that provides:
- **File Management**: Clean up old coverage files with optional archiving
- **Report Generation**: Generate HTML, JSON, and XML coverage reports
- **History Tracking**: SQLite database to track coverage trends over time
- **Automatic Management**: One-command solution for all coverage tasks

### 2. Archive Directory Structure
Location: `.coverage_archive/`

```
.coverage_archive/
├── archives/           # Archived old coverage files
├── reports/           # Generated coverage reports
│   ├── coverage_YYYYMMDD_HHMMSS/     # HTML reports
│   ├── coverage_YYYYMMDD_HHMMSS.json  # JSON reports
│   └── coverage_YYYYMMDD_HHMMSS.xml   # XML reports
└── coverage_history.db  # SQLite database for history
```

### 3. Makefile Integration
New targets added to the Makefile:
- `make coverage-clean`: Clean up old coverage files
- `make coverage-report`: Generate coverage reports
- `make coverage-history`: View coverage history
- `make coverage-auto`: Run automatic management

## Usage

### Command Line Interface

#### Clean Coverage Files
```bash
# Keep files from last 7 days (default), archive older ones
python scripts/manage_coverage.py clean

# Keep files from last 30 days
python scripts/manage_coverage.py clean --keep-days 30

# Delete instead of archiving
python scripts/manage_coverage.py clean --no-archive
```

#### Combine Coverage Files
```bash
# Combine all .coverage.* files into single .coverage
python scripts/manage_coverage.py combine
```

#### Generate Reports
```bash
# Generate HTML report (default)
python scripts/manage_coverage.py report

# Generate JSON report
python scripts/manage_coverage.py report --format json

# Generate XML report
python scripts/manage_coverage.py report --format xml
```

#### View Coverage History
```bash
# Show last 10 runs (default)
python scripts/manage_coverage.py history

# Show last 50 runs
python scripts/manage_coverage.py history --limit 50
```

#### Automatic Management
```bash
# Combine, report, and clean in one command
python scripts/manage_coverage.py auto
```

### Makefile Integration

The coverage management is integrated into the test workflow:

```bash
# Run tests (automatically cleans coverage files after)
make test

# Manual coverage management
make coverage-clean    # Clean old files
make coverage-report   # Generate HTML report
make coverage-history  # View history
make coverage-auto     # Run full management
```

## Configuration

### Retention Policy
- Default: Keep coverage files for 7 days
- Older files are archived to `.coverage_archive/archives/`
- Archives are preserved indefinitely unless manually deleted

### Report Formats
- **HTML**: Interactive browser-based reports
- **JSON**: Machine-readable format for CI/CD
- **XML**: Compatible with coverage tools like Cobertura

### Database Schema
The SQLite database tracks:
- Timestamp of coverage run
- Git branch and commit hash
- Coverage percentage
- Number of files and lines covered
- Paths to archived files and reports

## Best Practices

1. **Regular Cleanup**: Run `make coverage-clean` or add to CI/CD pipeline
2. **Archive Important Runs**: Keep archives of release/milestone coverage
3. **Monitor Trends**: Use `make coverage-history` to track coverage over time
4. **Automated Workflow**: Use `make coverage-auto` after test runs

## Gitignore Rules

The following patterns are added to `.gitignore`:
```
.coverage_archive/
.coverage.*.local.*
.coverage_reports/
coverage_*.json
coverage_*.xml
```

## Troubleshooting

### Coverage Files Not Combining
Ensure all test processes have completed before combining:
```bash
pkill -f pytest  # Kill any hanging test processes
python scripts/manage_coverage.py combine
```

### Database Errors
Reset the coverage database:
```bash
rm .coverage_archive/coverage_history.db
python scripts/manage_coverage.py auto  # Recreates database
```

### Missing Coverage Module
Install coverage if not present:
```bash
uv pip install coverage
```

## Integration with CI/CD

Add to your CI/CD pipeline:
```yaml
# Example GitHub Actions
- name: Run Tests with Coverage
  run: |
    make test
    make coverage-auto
    
- name: Upload Coverage Report
  uses: actions/upload-artifact@v2
  with:
    name: coverage-report
    path: .coverage_archive/reports/
```

## Future Enhancements

Potential improvements:
- Cloud storage integration for archives
- Coverage diff between branches
- Automated coverage alerts/notifications
- Integration with code quality dashboards
- Parallel test run coverage merging