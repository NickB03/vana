#!/bin/bash

# Git pre-commit hook for SPARC optimization
# Ensures M3 optimizations are applied before commits involving SPARC

# Check if any SPARC-related files are being committed
if git diff --cached --name-only | grep -E "(sparc|claude-flow|agent|swarm)" > /dev/null; then
    echo "üìä SPARC-related changes detected, checking system..."
    
    # Check if running on M3 MacBook Air
    if [[ $(uname -m) == "arm64" ]] && [[ $(sysctl -n hw.memsize) -le 17179869184 ]]; then
        echo "üéØ M3 MacBook Air detected - verifying optimizations..."
        
        # Check if optimization config exists
        if [ ! -f ".claude-flow.config.json" ]; then
            echo "‚ö†Ô∏è  Missing .claude-flow.config.json"
            echo "Creating default M3 configuration..."
            cp .claude_workspace/config/m3-sparc-optimization.json .claude-flow.config.json
        fi
        
        # Verify memory usage before commit
        MEM_FREE=$(vm_stat | grep "Pages free" | awk '{print $3}' | sed 's/\.//' | awk '{print $1*4096/1024/1024/1024}')
        
        if (( $(echo "$MEM_FREE < 2" | bc -l) )); then
            echo "‚ùå Insufficient memory for safe commit (${MEM_FREE}GB free)"
            echo "Please close some applications and try again"
            exit 1
        fi
        
        echo "‚úÖ M3 optimizations verified"
    fi
fi

exit 0