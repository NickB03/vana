# Phase 1.3 Progress: Server-Side HTML Transformations

**Status:** Step 1 Complete ‚úÖ | Ready for Step 2 (Deploy & Test)

---

## Overview

Moving ~300 lines of client-side HTML manipulation from `ArtifactRenderer.tsx` (lines 172-481) to server-side in `bundle-artifact/index.ts`. This eliminates 50-100ms of processing time and ensures all new bundles are pre-patched before storage upload.

---

## Step 1: Add Server-Side Functions ‚úÖ COMPLETE

**Commit:** `feat: add server-side HTML transformations for bundle-artifact (Phase 1.3 Step 1)`

### Changes Made

Added 4 new helper functions to `supabase/functions/bundle-artifact/index.ts` (lines 290-444):

1. **ensureLibraryInjection()** (lines 290-334)
   - Detects: PropTypes, Framer Motion, Lucide, Canvas Confetti usage
   - Injects: `<script>` tags before `</head>` or after ReactDOM
   - Replaces: ~50 lines of client-side library detection

2. **normalizeExports()** (lines 336-359)
   - Fixes: `const * as X from 'pkg'` ‚Üí `import * as X from 'pkg'`
   - Fixes: `from React;` ‚Üí `from 'react';`
   - Replaces: ~20 lines of client-side syntax fixes

3. **fixDualReactInstance()** (lines 361-418)
   - Fixes: esm.sh `?deps=` ‚Üí `?external=` to prevent dual React instances
   - Updates: CSP to allow `data:` URLs for import map shims
   - Injects: React import map redirects to window globals
   - Replaces: ~150 lines of client-side React instance fixes

4. **unescapeTemplateLiterals()** (lines 420-444)
   - Fixes: `\`` ‚Üí `` ` `` and `\$` ‚Üí `$` in module scripts
   - Replaces: ~20 lines of client-side unescaping

### Integration Point

Modified `generateBundleHtml()` to apply transformations before returning (lines 658-667):

```typescript
// Apply server-side transformations before uploading
// These replace ~300 lines of client-side code in ArtifactRenderer.tsx
let finalHtml = htmlTemplate;
finalHtml = ensureLibraryInjection(finalHtml, params.code);
finalHtml = normalizeExports(finalHtml);
finalHtml = fixDualReactInstance(finalHtml);
finalHtml = unescapeTemplateLiterals(finalHtml);

const htmlSize = new TextEncoder().encode(finalHtml).length;
return { html: finalHtml, size: htmlSize };
```

### Validation

- ‚úÖ TypeScript check passes: `deno check index.ts`
- ‚úÖ Test suite: 578 passed, 9 pre-existing failures (unrelated)
- ‚úÖ Git pre-commit hook passes (critical files validated)
- ‚úÖ No breaking changes to existing bundle generation logic

---

## Step 2: Deploy & Test üöß IN PROGRESS

**Goal:** Verify server-side transformations work in production before removing client-side code.

**Detailed Testing Guide:** See `docs/PHASE_1_3_TEST_EXECUTION_CHECKLIST.md` for comprehensive step-by-step instructions.

### Deployment

```bash
cd /Users/nick/Projects/llm-chat-site
./scripts/deploy-simple.sh prod
```

**Deployment Status:**
- [ ] Function deployed successfully
- [ ] Deployment verified (check function logs)
- [ ] No errors during deployment

**Expected output:**
```
Deploying bundle-artifact
‚úì Deployed (v123) bundle-artifact. Serving at:
  - https://<project-ref>.supabase.co/functions/v1/bundle-artifact
```

### Testing Checklist

**Instructions:** Follow detailed procedures in `docs/PHASE_1_3_TEST_EXECUTION_CHECKLIST.md`

Test artifacts that trigger each transformation:

#### 1. PropTypes Injection
- [ ] Created Recharts component
- [ ] Bundle includes PropTypes script tag
- [ ] `window.PropTypes` is defined
- [ ] Artifact renders without errors
- **Status:** [ ] PASS / [ ] FAIL
- **Notes:** _____________________

#### 2. Framer Motion Injection
- [ ] Created component with animation
- [ ] Bundle includes Framer Motion script tag
- [ ] `window.motion` is defined
- [ ] Animation works smoothly
- **Status:** [ ] PASS / [ ] FAIL
- **Notes:** _____________________

#### 3. Lucide Icons Injection
- [ ] Created component with lucide-react icons
- [ ] Bundle includes Lucide script tag
- [ ] `window.LucideIcons` is defined
- [ ] Icons render correctly
- **Status:** [ ] PASS / [ ] FAIL
- **Notes:** _____________________

#### 4. Canvas Confetti Injection
- [ ] Created component with confetti animation
- [ ] Bundle includes canvas-confetti script tag
- [ ] `window.confetti` is defined
- [ ] Confetti effect triggers on click
- **Status:** [ ] PASS / [ ] FAIL
- **Notes:** _____________________

#### 5. Import Syntax Normalization
- [ ] Generated artifact with complex imports
- [ ] Inspected HTML source for `import * as` syntax
- [ ] No `const * as` syntax present
- [ ] Artifact executes without import errors
- **Status:** [ ] PASS / [ ] FAIL
- **Notes:** _____________________

#### 6. Dual React Instance Fix
- [ ] Created artifact with npm package (@radix-ui/react-dialog)
- [ ] esm.sh URLs use `?external=react,react-dom`
- [ ] CSP includes `data:` in `script-src`
- [ ] Import map redirects React to window globals
- [ ] No "Invalid hook call" errors
- **Status:** [ ] PASS / [ ] FAIL
- **Notes:** _____________________

#### 7. Template Literal Unescaping
- [ ] Created artifact with template literals
- [ ] Module script has unescaped backticks
- [ ] Template string interpolation works
- [ ] No syntax errors
- **Status:** [ ] PASS / [ ] FAIL
- **Notes:** _____________________

#### 8. Performance Verification
- [ ] Measured bundle processing time
- [ ] No client-side HTML manipulation visible
- [ ] 50-100ms faster or no transformation overhead
- [ ] Main thread blocking reduced
- **Status:** [ ] PASS / [ ] FAIL
- **Performance Data:** _____________________

### Test Execution Report

**Test Date:** [YYYY-MM-DD]
**Tester:** [Name]
**Environment:** Production (`https://chat.geminixai.app/`)
**Browser:** Chrome [Version]

### Detailed Results

#### Category 1: PropTypes Injection
**Status:** ‚è≥ Pending / ‚úÖ PASS / ‚ùå FAIL
**Evidence:** [Screenshot/log link]
**Console Output:** [Error messages if any]
**HTML Verification:** [Script tag found: YES/NO]
**Global Check:** [`window.PropTypes` defined: YES/NO]
**Notes:**

---

#### Category 2: Framer Motion Injection
**Status:** ‚è≥ Pending / ‚úÖ PASS / ‚ùå FAIL
**Evidence:** [Screenshot/log link]
**Console Output:** [Error messages if any]
**HTML Verification:** [Script tag found: YES/NO]
**Global Check:** [`window.motion` defined: YES/NO]
**Animation Quality:** [Smooth/Jerky/Not working]
**Notes:**

---

#### Category 3: Lucide Icons Injection
**Status:** ‚è≥ Pending / ‚úÖ PASS / ‚ùå FAIL
**Evidence:** [Screenshot/log link]
**Console Output:** [Error messages if any]
**HTML Verification:** [Script tags found: YES/NO]
**Global Check:** [`window.LucideIcons` defined: YES/NO, Individual icons: YES/NO]
**Icons Rendered:** [Number of icons visible]
**Notes:**

---

#### Category 4: Canvas Confetti Injection
**Status:** ‚è≥ Pending / ‚úÖ PASS / ‚ùå FAIL
**Evidence:** [Screenshot/log link]
**Console Output:** [Error messages if any]
**HTML Verification:** [Script tag found: YES/NO]
**Global Check:** [`window.confetti` defined: YES/NO]
**Animation Trigger:** [Worked/Failed]
**Notes:**

---

#### Category 5: Import Syntax Normalization
**Status:** ‚è≥ Pending / ‚úÖ PASS / ‚ùå FAIL
**Evidence:** [Screenshot/log link]
**Console Output:** [Error messages if any]
**HTML Inspection:** [Valid import syntax: YES/NO]
**Invalid Syntax Found:** [`const * as` present: YES/NO]
**Component Functionality:** [Working/Broken]
**Notes:**

---

#### Category 6: Dual React Instance Fix
**Status:** ‚è≥ Pending / ‚úÖ PASS / ‚ùå FAIL
**Evidence:** [Screenshot/log link]
**Console Output:** [Error messages if any]
**esm.sh URLs:** [Use `?external=`: YES/NO]
**CSP Header:** [Includes `data:`: YES/NO]
**Import Map:** [Redirects present: YES/NO]
**React DevTools:** [Single instance: YES/NO]
**Hook Errors:** [None/List errors]
**Notes:**

---

#### Category 7: Template Literal Unescaping
**Status:** ‚è≥ Pending / ‚úÖ PASS / ‚ùå FAIL
**Evidence:** [Screenshot/log link]
**Console Output:** [Error messages if any]
**HTML Inspection:** [Backticks unescaped: YES/NO]
**String Interpolation:** [Works/Broken]
**Syntax Errors:** [None/List errors]
**Notes:**

---

#### Category 8: Performance
**Status:** ‚è≥ Pending / ‚úÖ PASS / ‚ùå FAIL
**Evidence:** [Performance profile link]
**Baseline Time:** [Before optimization]
**Current Time:** [After optimization]
**Improvement:** [X ms faster]
**Client-side Processing:** [Present/Absent]
**Main Thread Blocking:** [Reduced/Same/Worse]
**Notes:**

---

### Summary Statistics

**Tests Completed:** [X / 8]
**Tests Passed:** [X / 8]
**Tests Failed:** [X / 8]
**Pass Rate:** [X%]

### Critical Issues Found
[List any blocking issues that prevent Step 3]

1. _____________________
2. _____________________

### Non-Critical Issues Found
[List minor issues that don't block Step 3]

1. _____________________
2. _____________________

### Go/No-Go Decision Framework

**Decision:** [ ] ‚úÖ GO / [ ] ‚ùå NO-GO / [ ] ‚è≥ PENDING

**Criteria for GO (ALL must be met):**
- [ ] All 8 test categories PASS (7 transformations + 1 performance)
- [ ] Zero critical issues found
- [ ] No console errors in production artifacts
- [ ] Performance improvement verified (50-100ms faster or no processing overhead)
- [ ] Supabase function logs show no error rate increase
- [ ] Artifacts render correctly across all test cases

**Criteria for NO-GO (ANY can trigger):**
- [ ] One or more test categories FAIL
- [ ] Critical issues found (security, data loss, widespread errors)
- [ ] Console errors appear consistently
- [ ] Performance regression detected
- [ ] Error rate increased in Supabase logs
- [ ] Artifacts fail to render or have broken functionality

**Rationale:**
[Explain the decision. If GO, confirm all criteria met. If NO-GO, list specific blocking issues.]

_____________________
_____________________
_____________________

### Production Smoke Test

After deployment, test one artifact from each category above in production:
- **URL:** `https://chat.geminixai.app/`
- **Method:** Create new session ‚Üí Generate artifacts ‚Üí Verify rendering

**Smoke Test Results:**
- [ ] PropTypes artifact works in production
- [ ] Framer Motion artifact works in production
- [ ] Lucide Icons artifact works in production
- [ ] Canvas Confetti artifact works in production
- [ ] Complex import artifact works in production
- [ ] Radix UI artifact works in production
- [ ] Template literal artifact works in production

**Overall Smoke Test:** [ ] PASS / [ ] FAIL

If any test fails, **DO NOT PROCEED TO STEP 3**. Investigate and fix before removing client-side code.

### Next Actions

**If GO Decision:**
1. [ ] Update this document with "Step 2 Complete ‚úÖ"
2. [ ] Archive test evidence (screenshots, logs, performance profiles)
3. [ ] Commit test results to git
4. [ ] Proceed to Step 3 (remove client-side code)
5. [ ] Update ARCHITECTURE.md with server-side transformation flow

**If NO-GO Decision:**
1. [ ] File bug reports for failing tests (with reproduction steps)
2. [ ] Create GitHub issues for critical problems
3. [ ] Investigate root causes of failures
4. [ ] Implement fixes in separate branch
5. [ ] Re-run Step 2 testing after fixes
6. [ ] Do NOT proceed to Step 3 until all tests pass

**If Rollback Required:**
1. [ ] Execute rollback procedure (see below)
2. [ ] Document issues in post-mortem
3. [ ] Plan fixes and re-deployment strategy

---

### Rollback Procedure

**If critical issues discovered during testing:**

```bash
# 1. Identify the Step 1 commit hash
git log --oneline -10 | grep "Phase 1.3 Step 1"

# 2. Revert the server-side transformation commit
git revert [COMMIT_HASH]

# 3. Push revert commit
git push origin main

# 4. Redeploy bundle-artifact function
./scripts/deploy-simple.sh prod

# 5. Verify rollback successful
# - Generate test artifact
# - Confirm old behavior restored
# - Check Supabase function logs
```

**Rollback Impact:**
- Server-side transformation functions removed
- Client-side code still present and functional
- No data loss or breaking changes
- Old cached bundles unaffected

**Rollback Time:** ~3-5 minutes

**Post-Rollback Actions:**
1. Document issues in detail
2. Create bug reports with evidence
3. Plan fixes in development branch
4. Schedule re-testing session after fixes deployed

---

## Step 3: Remove Client-Side Code ‚è≥ PENDING

**Prerequisites:**
- ‚úÖ Step 1 complete (server-side functions added)
- ‚è≥ Step 2 complete (deployed and tested in production)
- ‚è≥ All 7 test categories pass
- ‚è≥ Performance improvement verified (50-100ms faster)

**Action:** Remove lines 172-481 from `src/components/ArtifactRenderer.tsx` once Step 2 validation passes.

**File:** `src/components/ArtifactRenderer.tsx`
**Lines to remove:** 172-481 (~300 lines)
**Replace with:**
```typescript
// Server-side transformations (bundle-artifact/index.ts lines 290-444):
// 1. ensureLibraryInjection() - PropTypes, Framer Motion, Lucide, Canvas Confetti
// 2. normalizeExports() - Fix GLM syntax errors
// 3. fixDualReactInstance() - Fix esm.sh dual React instances
// 4. unescapeTemplateLiterals() - Unescape template literal syntax
//
// All new bundles are pre-patched server-side before storage upload.
// Old cached bundles (created before 2026-01-14) may still need client-side fixes,
// but will eventually expire (4-week TTL) and be replaced with pre-patched versions.
```

**Commit message template:**
```
feat: remove client-side bundle transformations (Phase 1.3 Step 3)

Remove ~300 lines of client-side HTML manipulation from ArtifactRenderer.tsx
now that transformations happen server-side in bundle-artifact Edge Function.

Changes:
- Remove applyBundleTransformations() function (lines 172-481)
- All new bundles arrive pre-patched from storage
- 50-100ms faster: No client-side HTML manipulation needed
- Old cached bundles still work (client-side code removed)

Testing:
- ‚úÖ Deployed to production (Step 2)
- ‚úÖ All 7 transformation categories verified
- ‚úÖ Performance improvement confirmed (50-100ms faster)
- ‚úÖ No rendering errors in production

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
```

---

## Architecture Notes

### Why Server-First?

1. **No Breaking Changes:** New functions added without modifying existing logic
2. **Safe Rollback:** If transformations fail, client-side code still works
3. **Incremental Testing:** Can test server transformations before removing client code
4. **Zero Downtime:** Old bundles cached, new bundles pre-patched

### Backward Compatibility

**Old bundles (cached before 2026-01-14):**
- Were generated WITHOUT server-side transformations
- Stored in Supabase Storage with 4-week TTL
- Still work correctly (no client-side code removal yet)
- Will eventually expire and be replaced with pre-patched versions

**New bundles (generated after Step 1 deployment):**
- ARE generated WITH server-side transformations
- Arrive pre-patched from storage
- Don't need client-side fixes (but code still present until Step 3)
- Render 50-100ms faster due to eliminated processing

### Cache Invalidation Strategy

**No manual cache clearing needed.** Here's why:

1. Bundle cache uses **content hash** as key (includes code + dependencies + bundleReact + title)
2. Same artifact code ‚Üí same hash ‚Üí cache hit (returns old bundle)
3. Different artifact code ‚Üí different hash ‚Üí cache miss (generates new bundle with transformations)

**Transition period (Step 1 ‚Üí Step 3):**
- Old bundles: Cached, work fine, no transformations applied
- New bundles: Generated with transformations, work fine, render faster
- Client code: Still applies transformations (no-op for new bundles, fixes old bundles)

**After Step 3 (client code removed):**
- Old bundles: Still cached (4 weeks max), render correctly (transformations baked in HTML)
- New bundles: Generated with transformations, render correctly
- Old bundles expire naturally after 28 days, replaced with pre-patched versions

**Edge case: Regenerating old artifact**
- User clicks "regenerate" on old artifact ‚Üí triggers bundle-artifact API
- New bundle generated with server-side transformations applied
- Cache updated with pre-patched version
- Old cache entry evicted, new entry used going forward

---

## Risk Assessment

### Low Risk ‚úÖ
- Adding new functions without modifying existing logic
- Transformations are idempotent (safe to apply multiple times)
- TypeScript validated, tests passing
- Git pre-commit hooks passed

### Medium Risk ‚ö†Ô∏è
- Regex patterns in transformations could have edge cases
- Import map manipulation could break for non-standard syntax
- CSP modification could be too aggressive/too permissive

### Mitigation ‚úÖ
- **Step 2 testing** catches issues before client code removal
- **Backward compatibility** ensures old bundles keep working
- **Rollback plan:** Revert Step 1 commit if critical issues found
- **Gradual rollout:** Only new bundles get transformations initially

---

## Rollback Plan

If critical issues discovered in Step 2 testing:

```bash
# Revert Step 1 commit
git revert HEAD

# Redeploy original bundle-artifact
./scripts/deploy-simple.sh prod

# Investigate and fix issues
# Re-apply Step 1 when fixed
```

**No data loss:** Old bundles remain cached and functional.

---

## Success Criteria

**Step 2 (Deploy & Test) passes if:**
1. ‚úÖ All 7 transformation test categories pass
2. ‚úÖ No console errors in production
3. ‚úÖ Bundles render correctly in Chrome/Safari/Firefox
4. ‚úÖ Performance improvement verified (50-100ms faster)
5. ‚úÖ No increase in error rates (check Supabase function logs)

**Proceed to Step 3 only if all 5 criteria met.**

---

## Timeline

- **2026-01-14:** Step 1 complete (server-side functions added)
- **Next:** Deploy to production and run Step 2 validation
- **After validation:** Remove client-side code (Step 3)
- **Target:** Complete Phase 1.3 by end of week

---

## Related Files

**Modified:**
- `supabase/functions/bundle-artifact/index.ts` (lines 290-444, 658-667)

**To be modified (Step 3):**
- `src/components/ArtifactRenderer.tsx` (lines 172-481)

**Documentation:**
- `.claude/ARCHITECTURE.md` - Update with server-side transformation architecture
- `.claude/ARTIFACT_SYSTEM.md` - Document bundle generation flow changes

---

## Questions / Notes

**Q: Why not remove client code immediately?**
A: Safety. Server transformations need production validation before we rely on them exclusively.

**Q: What about old cached bundles?**
A: They work fine without server transformations (HTML already correct or client code fixes them).

**Q: How long until all bundles are pre-patched?**
A: 4 weeks max (bundle cache TTL). High-traffic artifacts regenerate within days/hours.

**Q: Can we test locally?**
A: Yes. `supabase start` runs local Edge Functions. Test with `http://localhost:54321/functions/v1/bundle-artifact`.

**Q: What if transformation breaks production?**
A: Revert Step 1 commit, redeploy. Old bundles unaffected. Fix issue and re-apply.

---

**Last updated:** 2026-01-14
**Status:** Step 1 complete, ready for Step 2 deployment
