name: CI Pipeline (Local Runner)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'
  CACHE_VERSION: 'v4'

jobs:
  # Quick structure detection
  detect:
    runs-on: [self-hosted, docker]
    outputs:
      has_backend: ${{ steps.detect.outputs.has_backend }}
      has_frontend: ${{ steps.detect.outputs.has_frontend }}
    steps:
      - uses: actions/checkout@v4
      
      - id: detect
        run: |
          echo "has_backend=$([[ -f pyproject.toml ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "has_frontend=$([[ -d frontend ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

  # Backend tests - using local Python
  backend:
    needs: detect
    if: needs.detect.outputs.has_backend == 'true'
    runs-on: [self-hosted, docker]
    steps:
      - uses: actions/checkout@v4
      
      - name: Cache Python deps
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: py-${{ hashFiles('pyproject.toml', 'uv.lock') }}
      
      - name: Setup and test backend
        run: |
          # Use local Python with uv
          curl -LsSf https://astral.sh/uv/install.sh | sh || true
          source $HOME/.cargo/env
          
          # Install deps and run tests
          uv sync --dev
          
          # Lint (fast)
          uv run ruff check . || true
          
          # Unit tests with timeout
          uv run pytest tests/unit -v --timeout=60 -x || true

  # Frontend tests - using local Node
  frontend:
    needs: detect
    if: needs.detect.outputs.has_frontend == 'true'
    runs-on: [self-hosted, docker]
    steps:
      - uses: actions/checkout@v4
      
      - name: Cache Node deps
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            frontend/node_modules
          key: node-${{ hashFiles('frontend/pnpm-lock.yaml') }}
      
      - name: Setup and test frontend
        run: |
          cd frontend
          
          # Install pnpm if needed
          npm install -g pnpm || true
          
          # Install deps
          pnpm install --frozen-lockfile
          
          # Quick checks
          pnpm typecheck || true
          pnpm lint || true
          pnpm test --passWithNoTests || true
          
          # Build
          pnpm build

  # Docker-based security scan (isolated)
  security:
    needs: detect
    if: github.ref == 'refs/heads/main' && needs.detect.outputs.has_backend == 'true'
    runs-on: [self-hosted, docker]
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      
      - name: Security scan in Docker
        run: |
          docker run --rm -v $(pwd):/workspace \
            -w /workspace \
            python:3.11-slim \
            bash -c "
              pip install bandit pip-audit &&
              bandit -r app/ -f json || true &&
              pip-audit --desc || true
            "

  # Status check
  status:
    if: always()
    needs: [backend, frontend, security]
    runs-on: [self-hosted, docker]
    steps:
      - name: Report status
        run: |
          echo "CI Pipeline Complete"
          echo "Backend: ${{ needs.backend.result }}"
          echo "Frontend: ${{ needs.frontend.result }}"
          echo "Security: ${{ needs.security.result }}"