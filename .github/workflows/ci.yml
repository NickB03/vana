name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GOOGLE_CLOUD_PROJECT: ${{ secrets.GOOGLE_CLOUD_PROJECT }}
      GOOGLE_CLOUD_LOCATION: ${{ secrets.GOOGLE_CLOUD_LOCATION }}
      GOOGLE_STORAGE_BUCKET: ${{ secrets.GOOGLE_STORAGE_BUCKET }}
      GOOGLE_APPLICATION_CREDENTIALS: ./secrets/service-account-key.json
      VECTOR_SEARCH_INDEX_NAME: vana-shared-index
      VECTOR_SEARCH_DIMENSIONS: 768

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        elif [ -f "Project Setup/adk-setup/requirements.txt" ]; then
          pip install -r "Project Setup/adk-setup/requirements.txt"
        else
          echo "No requirements.txt found. Installing basic dependencies."
          pip install pytest python-dotenv google-cloud-aiplatform vertexai google-cloud-storage
        fi

    - name: Set up Google Cloud credentials
      if: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}
      run: |
        mkdir -p secrets
        echo "${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}" > ./secrets/service-account-key.json

    - name: Run tests
      run: |
        pytest || echo "No tests found or pytest not installed"

    - name: Verify Vector Search
      if: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}
      run: |
        python verify_vector_search.py || echo "Vector Search verification failed but continuing"