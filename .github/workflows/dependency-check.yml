name: Dependency Check

env:
  PYTHON_VERSION: '3.11'
  UV_VERSION: '0.6.12'
  CACHE_VERSION: 'v4'

on:
  schedule:
    - cron: '0 6 * * 1'  # Weekly on Mondays at 6 AM
  workflow_dispatch:
  push:
    paths:
      - 'pyproject.toml'
      - 'uv.lock'

permissions:
  contents: read

jobs:
  dependency-check:
    name: Dependency Security & Compatibility Check
    # Migrated to self-hosted runner - 2025-09-03
    runs-on: [self-hosted, docker]
    timeout-minutes: 8
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup uv
        uses: astral-sh/setup-uv@v3
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: true
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: deps-${{ env.CACHE_VERSION }}-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
          restore-keys: |
            deps-${{ env.CACHE_VERSION }}-${{ runner.os }}-${{ env.PYTHON_VERSION }}-

      - name: Check dependency resolution
        run: |
          echo "::group::Dependency Resolution Check"
          uv sync --dev --no-install-project
          echo "✓ Dependencies resolved successfully"
          echo "::endgroup::"

      - name: Basic vulnerability scan
        run: |
          echo "::group::Vulnerability Scan"
          uv sync --dev
          uv pip install pip-audit
          uv run pip-audit --short-format || echo "⚠️ Vulnerabilities found - review required"
          echo "::endgroup::"

      - name: Generate dependency summary
        run: |
          echo "## Dependency Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Python version**: $(python --version)" >> $GITHUB_STEP_SUMMARY
          echo "- **UV version**: $(uv --version)" >> $GITHUB_STEP_SUMMARY
          echo "- **Dependencies resolved**: ✅" >> $GITHUB_STEP_SUMMARY
          echo "- **Security scan**: $(uv run safety check --short-report > /dev/null 2>&1 && echo '✅ Clean' || echo '⚠️ Issues found')" >> $GITHUB_STEP_SUMMARY