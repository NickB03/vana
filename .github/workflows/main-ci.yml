name: Main CI/CD Pipeline (Performance Optimized)

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.claude_workspace/**'
      - '*.txt'
  pull_request:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.claude_workspace/**'
      - '*.txt'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip test execution'
        required: false
        default: false
        type: boolean
      performance_mode:
        description: 'Enable performance mode'
        required: false
        default: true
        type: boolean

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'
  UV_VERSION: '0.5.11'
  CACHE_VERSION: 'v2'  # Increment to bust caches
  PERFORMANCE_MODE: ${{ github.event.inputs.performance_mode || 'true' }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  actions: read
  pull-requests: read

jobs:
  # ============================================================================
  # CHANGE DETECTION & SETUP
  # ============================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    timeout-minutes: 1
    outputs:
      backend: ${{ steps.changes.outputs.backend }}
      frontend: ${{ steps.changes.outputs.frontend }}
      deps: ${{ steps.changes.outputs.deps }}
      tests: ${{ steps.changes.outputs.tests }}
      workflows: ${{ steps.changes.outputs.workflows }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Detect file changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            backend:
              - 'app/**'
              - 'pyproject.toml'
              - 'uv.lock'
            frontend:
              - 'frontend/**'
              - 'frontend/package*.json'
            deps:
              - 'pyproject.toml'
              - 'uv.lock'
              - 'frontend/package*.json'
            tests:
              - 'tests/**'
              - 'app/**'
              - 'frontend/**'
            workflows:
              - '.github/workflows/**'

  # ============================================================================
  # OPTIMIZED SMOKE TESTS
  # ============================================================================
  smoke-tests:
    name: Quick Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 2
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true' || needs.detect-changes.outputs.frontend == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          
      - name: Setup Python with cache
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: Setup Node.js with enhanced cache
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'
          
      - name: Cache UV installation
        uses: actions/cache@v4
        with:
          path: ~/.local/bin/uv
          key: uv-${{ env.UV_VERSION }}-${{ runner.os }}
          
      - name: Install UV (cached)
        run: |
          if [ ! -f ~/.local/bin/uv ]; then
            curl -LsSf "https://astral.sh/uv/${{ env.UV_VERSION }}/install.sh" | sh
          fi
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
      - name: Parallel syntax checks
        run: |
          # Run checks in parallel
          (
            echo "Checking Python syntax..."
            python -m py_compile app/server.py
            echo "✅ Python syntax OK"
          ) &
          
          (
            echo "Checking Node.js dependencies..."
            cd frontend && npm ci --prefer-offline --no-audit --silent
            echo "✅ Frontend dependencies OK"
          ) &
          
          wait # Wait for all background jobs
          
      - name: Quick import verification
        run: |
          uv sync --no-dev --quiet
          # Test basic imports with better error handling for CI
          uv run python -c "
          try:
              from app.config import get_config
              _cfg = get_config()
              print('✅ Config load working')
              try:
                  from app import server
                  print('✅ Server import working')
              except Exception as e:
                  print('⚠️ Server import issue (expected in CI without auth):', str(e)[:100])
                  # This is expected in CI without Google Cloud credentials
                  if 'DefaultCredentialsError' in str(e) or 'Authentication' in str(e):
                      print('✅ Auth error is expected in CI environment')
                  else:
                      raise
          except Exception as e:
              print('❌ Basic import failed:', e)
              exit(1)
          print('✅ Core imports validation passed')
          "

  # ============================================================================
  # MATRIX BACKEND TESTS (PARALLEL)
  # ============================================================================
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    needs: [smoke-tests, detect-changes]
    if: needs.detect-changes.outputs.backend == 'true' || needs.detect-changes.outputs.tests == 'true'
    timeout-minutes: 6
    strategy:
      fail-fast: false
      matrix:
        test-group: [lint, unit, integration]
        include:
          - test-group: lint
            commands: |
              uv run ruff check . --output-format=github
              uv run mypy . --no-error-summary
          - test-group: unit
            commands: |
              uv run pytest tests/unit/ -v --tb=short --maxfail=5
          - test-group: integration
            commands: |
              uv run pytest tests/integration/ -v --tb=short -x
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python with cache
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: Restore UV cache
        uses: actions/cache@v4
        with:
          path: ~/.local/bin/uv
          key: uv-${{ env.UV_VERSION }}-${{ runner.os }}
          
      - name: Install UV (cached)
        run: |
          if [ ! -f ~/.local/bin/uv ]; then
            curl -LsSf "https://astral.sh/uv/${{ env.UV_VERSION }}/install.sh" | sh
          fi
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: python-${{ env.CACHE_VERSION }}-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
          restore-keys: |
            python-${{ env.CACHE_VERSION }}-${{ runner.os }}-${{ env.PYTHON_VERSION }}-
            
      - name: Install dependencies (optimized)
        run: |
          uv sync --dev --no-install-project
          uv sync --dev
          
      - name: Run ${{ matrix.test-group }} tests
        run: ${{ matrix.commands }}
        
      - name: Upload test results
        if: always() && matrix.test-group != 'lint'
        uses: actions/upload-artifact@v4
        with:
          name: backend-${{ matrix.test-group }}-results
          path: |
            .coverage
            pytest-report.xml
          retention-days: 3

  # ============================================================================
  # FRONTEND TESTS
  # ============================================================================
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    needs: smoke-tests
    timeout-minutes: 8
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'
          
      - name: Install dependencies
        run: |
          cd frontend
          npm ci --prefer-offline --no-audit
          
      - name: Run linting
        run: |
          cd frontend
          npm run lint
          
      - name: Type check
        run: |
          cd frontend
          npx tsc --noEmit
          
      - name: Build check
        run: |
          cd frontend
          npm run build

  # ============================================================================
  # INTEGRATION TESTS
  # ============================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    timeout-minutes: 12
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'
          
      - name: Install UV (stable)
        run: |
          curl -LsSf "https://astral.sh/uv/${{ env.UV_VERSION }}/install.sh" | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
      - name: Restore caches
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
            ~/.npm
            frontend/node_modules
          key: integration-${{ runner.os }}-${{ env.NODE_VERSION }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('pyproject.toml', 'frontend/package-lock.json') }}
          
      - name: Install all dependencies
        run: |
          uv sync --dev
          cd frontend && npm ci --prefer-offline --no-audit
          
      - name: Start backend for testing
        run: |
          uv run uvicorn app.server:app --host 0.0.0.0 --port 8000 &
          sleep 5
          curl -f http://localhost:8000/health || exit 1
          
      - name: Run integration tests
        run: |
          uv run pytest tests/integration/ -v --tb=short

  # ============================================================================
  # SECURITY SCAN (SIMPLIFIED)
  # ============================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: smoke-tests
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install UV (stable)
        run: |
          curl -LsSf "https://astral.sh/uv/${{ env.UV_VERSION }}/install.sh" | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
      - name: Install security tools
        run: |
          uv sync --dev
          
      - name: Run security checks
        run: |
          uv run bandit -r app/ -f json -o bandit-report.json || true
          uv run safety check --json --output safety-report.json || true
          
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports-${{ github.sha }}
          path: |
            bandit-report.json
            safety-report.json
          retention-days: 7

  # ============================================================================
  # FINAL STATUS
  # ============================================================================
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [smoke-tests, backend-tests, frontend-tests, integration-tests, security-scan]
    if: always()
    
    steps:
      - name: Check CI status
        run: |
          echo "## CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Smoke tests**: ${{ needs.smoke-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend tests**: ${{ needs.backend-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend tests**: ${{ needs.frontend-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Integration tests**: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Security scan**: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.smoke-tests.result }}" == "success" ]] && \
             [[ "${{ needs.backend-tests.result }}" == "success" ]] && \
             [[ "${{ needs.frontend-tests.result }}" == "success" ]] && \
             [[ "${{ needs.integration-tests.result }}" == "success" ]]; then
            echo "✅ **Overall Status: PASSED**" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "❌ **Overall Status: FAILED**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi