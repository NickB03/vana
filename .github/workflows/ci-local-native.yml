name: CI Pipeline (Local Native)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Prevent multiple runs from stacking up and burning minutes
concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'
  CACHE_VERSION: 'v4'

jobs:
  # Quick structure detection
  detect:
    runs-on: [self-hosted, macOS, ARM64]
    timeout-minutes: 5
    outputs:
      has_backend: ${{ steps.detect.outputs.has_backend }}
      has_frontend: ${{ steps.detect.outputs.has_frontend }}
    steps:
      - uses: actions/checkout@v4
      
      - id: detect
        run: |
          echo "has_backend=$([[ -f pyproject.toml ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "has_frontend=$([[ -d frontend ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

  # Backend tests - native on macOS
  backend:
    needs: detect
    if: needs.detect.outputs.has_backend == 'true'
    runs-on: [self-hosted, macOS, ARM64]
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python with uv
        run: |
          # Install uv if not present
          if ! command -v uv >/dev/null 2>&1; then
            echo "Installing uv..."
            curl -LsSf https://astral.sh/uv/install.sh | sh
            export PATH="$HOME/.cargo/bin:$PATH"
          fi
          
          echo "Using uv at: $(which uv)"
          uv --version
      
      - name: Cache Python deps
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: py-${{ hashFiles('pyproject.toml', 'uv.lock') }}
      
      - name: Test backend
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          
          # Install dependencies
          uv sync --dev || echo "WARNING: Some dependencies failed"
          
          # Lint
          uv run ruff check . || echo "WARNING: Linting issues found"
          
          # Run tests if available
          if [ -d "tests/unit" ]; then
            uv run pytest tests/unit -v --timeout=60 -x || echo "WARNING: Some tests failed"
          else
            echo "INFO: No unit tests found"
          fi

  # Frontend tests - native on macOS
  frontend:
    needs: detect
    if: needs.detect.outputs.has_frontend == 'true'
    runs-on: [self-hosted, macOS, ARM64]
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        run: |
          # Check Node version
          if command -v node >/dev/null 2>&1; then
            echo "Node.js version: $(node --version)"
          else
            echo "ERROR: Node.js not found. Please install Node.js 20"
            exit 1
          fi
      
      - name: Cache Node deps
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            frontend/node_modules
          key: node-${{ hashFiles('frontend/pnpm-lock.yaml') }}
      
      - name: Test frontend
        run: |
          cd frontend
          
          # Install pnpm if needed
          npm install -g pnpm || echo "pnpm might already be installed"
          
          # Install dependencies
          pnpm install --frozen-lockfile || echo "WARNING: Some deps failed"
          
          # TypeScript check
          pnpm typecheck || echo "WARNING: TypeScript issues"
          
          # Lint
          pnpm lint || echo "WARNING: Linting issues"
          
          # Build
          pnpm build || echo "ERROR: Build failed"

  # Status check
  status:
    if: always()
    needs: [backend, frontend]
    runs-on: [self-hosted, macOS, ARM64]
    timeout-minutes: 5
    steps:
      - name: Report status
        run: |
          echo "CI Pipeline Complete"
          echo "Backend: ${{ needs.backend.result }}"
          echo "Frontend: ${{ needs.frontend.result }}"