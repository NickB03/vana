name: CodeRabbit Review Notification

on:
  # DISABLED: CodeRabbit integration needs PUSHOVER_TOKEN and PUSHOVER_USER secrets
  workflow_dispatch:
    inputs:
      enable_notifications:
        description: 'Configure PUSHOVER_TOKEN and PUSHOVER_USER secrets first'
        required: true
        default: false
        type: boolean
      pr_number:
        description: 'Pull request number'
        required: true
        type: string
      pr_title:
        description: 'Pull request title'
        required: true
        type: string
      pr_url:
        description: 'Pull request URL'
        required: true
        type: string

jobs:
  notify-pushover:
    # Only run if comment is from CodeRabbit and contains the summary
    if: |
      github.event.comment.user.login == 'coderabbitai' && 
      (contains(github.event.comment.body, 'Summary by CodeRabbit') || 
       contains(github.event.comment.body, '## Summary'))
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Extract PR Info
        id: pr_info
        run: |
          # Get PR number and title from the event
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "pr_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            echo "pr_title=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
            echo "pr_url=${{ github.event.issue.html_url }}" >> $GITHUB_OUTPUT
          else
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "pr_title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
            echo "pr_url=${{ github.event.pull_request.html_url }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Send Pushover Notification
        run: |
          # Send notification via Pushover API
          response=$(curl -s -X POST https://api.pushover.net/1/messages.json \
            -d "token=${{ secrets.PUSHOVER_TOKEN }}" \
            -d "user=${{ secrets.PUSHOVER_USER }}" \
            -d "title=üê∞ CodeRabbit Review Complete" \
            -d "message=PR #${{ steps.pr_info.outputs.pr_number }}: ${{ steps.pr_info.outputs.pr_title }}" \
            -d "url=${{ steps.pr_info.outputs.pr_url }}" \
            -d "url_title=View Pull Request" \
            -d "priority=0" \
            -d "sound=pushover")
          
          # Check if notification was sent successfully
          if echo "$response" | grep -q '"status":1'; then
            echo "‚úÖ Pushover notification sent successfully"
          else
            echo "‚ùå Failed to send Pushover notification"
            echo "Response: $response"
            exit 1
          fi
      
      - name: Log Notification Details
        if: always()
        run: |
          echo "üìä Notification Details:"
          echo "- PR Number: #${{ steps.pr_info.outputs.pr_number }}"
          echo "- PR Title: ${{ steps.pr_info.outputs.pr_title }}"
          echo "- PR URL: ${{ steps.pr_info.outputs.pr_url }}"
          echo "- Triggered by: CodeRabbit review completion"