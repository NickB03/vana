name: Edge Functions Tests

on:
  pull_request:
    paths:
      - 'supabase/functions/_shared/**'
      - 'supabase/functions/**/index.ts'
      - '.github/workflows/edge-functions-tests.yml'
  push:
    branches:
      - main
    paths:
      - 'supabase/functions/_shared/**'
      - 'supabase/functions/**/index.ts'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Cache Deno dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.deno
            ~/.cache/deno
          key: ${{ runner.os }}-deno-${{ hashFiles('**/deno.lock') }}
          restore-keys: |
            ${{ runner.os }}-deno-

      - name: Run tests with coverage
        run: |
          deno test \
            --allow-env \
            --allow-net \
            --allow-read \
            --coverage=coverage \
            --parallel \
            supabase/functions/_shared/__tests__/

      - name: Generate coverage report
        run: |
          deno coverage coverage --lcov > coverage.lcov

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.lcov
          fail_ci_if_error: false
          flags: edge-functions
          name: edge-functions-coverage
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Verify coverage threshold (90%)
        run: |
          # Extract coverage percentage from detailed report
          COVERAGE=$(deno coverage coverage --detailed | grep "^Total" | awk '{print $2}' | sed 's/%//')

          # Check if coverage meets threshold
          if [ -z "$COVERAGE" ]; then
            echo "âš ï¸  Warning: Could not extract coverage percentage"
            exit 0
          fi

          # Convert to integer for comparison
          COVERAGE_INT=$(echo "$COVERAGE" | cut -d'.' -f1)

          echo "ðŸ“Š Total Coverage: ${COVERAGE}%"

          if [ "$COVERAGE_INT" -lt 90 ]; then
            echo "âŒ Coverage is below 90% threshold (${COVERAGE}%)"
            exit 1
          else
            echo "âœ… Coverage meets 90% threshold (${COVERAGE}%)"
          fi

      - name: Generate detailed coverage report
        if: always()
        run: |
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          deno coverage coverage --detailed >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: |
            coverage/
            coverage.lcov
          retention-days: 7

  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Lint shared modules
        run: |
          deno lint supabase/functions/_shared/

      - name: Format check
        run: |
          deno fmt --check supabase/functions/_shared/

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Type check shared modules
        run: |
          deno check supabase/functions/_shared/*.ts
          deno check supabase/functions/_shared/__tests__/*.ts

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test, lint, type-check]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## Edge Functions Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "âœ… **Tests**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Tests**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.lint.result }}" == "success" ]; then
            echo "âœ… **Lint**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Lint**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.type-check.result }}" == "success" ]; then
            echo "âœ… **Type Check**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Type Check**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check overall status
        if: needs.test.result != 'success' || needs.lint.result != 'success' || needs.type-check.result != 'success'
        run: |
          echo "One or more checks failed"
          exit 1
