name: CI/CD Pipeline

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request_target:  # Use pull_request_target for security with self-hosted runners
    branches: [main]
    types: [opened, synchronize]

jobs:
  security_gate:
    name: Security Gate for Fork PRs
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_target'
    outputs:
      approved: ${{ steps.security_check.outputs.approved }}
    steps:
      - name: Security Check for Fork PRs
        id: security_check
        run: |
          if [[ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]]; then
            echo "::warning::Fork PR detected from ${{ github.event.pull_request.head.repo.full_name }}"
            echo "::error::Fork PRs are not automatically approved for self-hosted runners due to security risks"
            echo "::notice::Repository maintainers should manually review and approve this PR if safe"
            echo "approved=false" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "::notice::PR from trusted repository - proceeding with self-hosted runner"
            echo "approved=true" >> $GITHUB_OUTPUT
          fi

  test:
    name: Test Suite
    runs-on: self-hosted
    timeout-minutes: 15
    needs: [security_gate]
    if: always() && (needs.security_gate.outputs.approved == 'true' || github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          # For pull_request_target, checkout the PR branch securely
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}
      
      - name: Verify Runner Security Context
        run: |
          echo "âœ… Runner: ${{ runner.name }}"
          echo "âœ… OS: ${{ runner.os }}"
          echo "âœ… Working Directory: $(pwd)"
          echo "âœ… Event: ${{ github.event_name }}"
          echo "âœ… Repository: ${{ github.repository }}"
          if [[ "${{ github.event_name }}" == "pull_request_target" ]]; then
            echo "âœ… PR Head Repo: ${{ github.event.pull_request.head.repo.full_name }}"
            echo "âœ… PR Head SHA: ${{ github.event.pull_request.head.sha }}"
          fi
      
      - name: Run Tests
        run: |
          echo "ğŸ§ª Running test suite..."
          make test
      
      - name: Code Quality Checks
        run: |
          echo "ğŸ” Running lint checks..."
          make lint
          
      - name: Type Checking
        run: |
          echo "ğŸ”§ Running type checks..."
          make typecheck
      
      - name: Summary
        run: |
          echo "âœ… All checks passed!"
          echo "ğŸ“Š Test suite: âœ“"
          echo "ğŸ“Š Lint checks: âœ“" 
          echo "ğŸ“Š Type checks: âœ“"