name: Model Configuration Guard

# Purpose: Prevent accidental model name changes
# Runs on: Every push, PR, and before deployment

on:
  push:
    branches: [ main ]
    paths:
      - 'supabase/functions/_shared/config.ts'
      - 'supabase/functions/_shared/__tests__/model-config.snapshot.json'
      - 'supabase/functions/_shared/__tests__/model-config.test.ts'
  pull_request:
    paths:
      - 'supabase/functions/_shared/config.ts'
      - 'supabase/functions/_shared/__tests__/model-config.snapshot.json'
      - 'supabase/functions/_shared/__tests__/model-config.test.ts'

jobs:
  validate-model-config:
    name: Validate Model Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v1.x

      - name: Run Model Configuration Tests
        run: |
          cd supabase/functions
          deno test --allow-read --allow-env _shared/__tests__/model-config.test.ts
        env:
          # Prevent tests from making actual API calls in CI
          CI: true

      - name: Check for hardcoded model names
        run: |
          echo "üîç Scanning for hardcoded model names..."

          # Check if any function files have hardcoded model strings
          # (This is redundant with the test but provides early feedback)
          # Excludes: config.ts, test files, node_modules, comments (// and JSDoc)
          if grep -r --include="*.ts" -E "(google|moonshotai)/[a-z0-9\-\.]+" supabase/functions/ | grep -v "config.ts" | grep -v "__tests__" | grep -v "node_modules" | grep -v "^\s*//" | grep -v "^\s*\*" | grep -v "@default"; then
            echo "‚ùå Found potential hardcoded model names!"
            echo "üí° Use MODELS.* from config.ts instead"
            exit 1
          else
            echo "‚úÖ No hardcoded model names found"
          fi

      - name: Summary
        if: success()
        run: |
          echo "‚úÖ Model configuration validation passed"
          echo ""
          echo "Verified:"
          echo "  ‚Ä¢ Model names match golden snapshot"
          echo "  ‚Ä¢ No hardcoded model names"
          echo "  ‚Ä¢ Configuration is stable"

      - name: Failure Help
        if: failure()
        run: |
          echo "‚ö†Ô∏è  Model configuration tests failed!"
          echo ""
          echo "If this change was ACCIDENTAL:"
          echo "  ‚Üí Revert changes to config.ts"
          echo ""
          echo "If this change was INTENTIONAL:"
          echo "  ‚Üí Update model-config.snapshot.json"
          echo "  ‚Üí Update version field to today's date"
          echo "  ‚Üí Document reason in commit message"
          echo ""
          echo "See: supabase/functions/_shared/__tests__/MODEL_CONFIG_TESTS.md"
