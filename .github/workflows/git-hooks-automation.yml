name: Git Hooks Automation & CI/CD Integration

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly optimization at 2 AM UTC on Sundays
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      hook_type:
        description: 'Specific hook to test (optional)'
        required: false
        type: choice
        options:
          - 'all'
          - 'pre-task'
          - 'post-edit'
          - 'post-task'
          - 'session-end'
        default: 'all'
      performance_mode:
        description: 'Performance testing mode'
        required: false
        type: choice
        options:
          - 'standard'
          - 'stress'
          - 'benchmark'
        default: 'standard'

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'
  UV_VERSION: '0.6.12'
  HOOK_TIMEOUT: 300
  PARALLEL_EXECUTION: true

jobs:
  # ============================================================================
  # DEPENDENCY MANAGEMENT & SETUP
  # ============================================================================
  setup-environment:
    name: ðŸ”§ Setup Environment & Dependencies
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      dependencies-changed: ${{ steps.deps-check.outputs.changed }}
      
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # For dependency change detection
          
      - name: ðŸ Setup Python with UV
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: âš¡ Install UV package manager
        run: |
          curl -LsSf https://astral.sh/uv/${{ env.UV_VERSION }}/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'
          
      - name: ðŸ”‘ Generate cache key
        id: cache-key
        run: |
          echo "key=deps-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-node${{ env.NODE_VERSION }}-${{ hashFiles('pyproject.toml', 'uv.lock', 'frontend/package-lock.json') }}" >> $GITHUB_OUTPUT
          
      - name: ðŸ“¦ Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ~/.npm
            frontend/node_modules
            .venv
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            deps-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-node${{ env.NODE_VERSION }}-
            
      - name: ðŸ” Check dependency changes
        id: deps-check
        run: |
          if git diff HEAD^ HEAD --name-only | grep -E '(pyproject.toml|uv.lock|package-lock.json)'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi
          
      - name: ðŸ“¦ Install Python dependencies
        run: |
          uv sync --dev --extra jupyter
          
      - name: ðŸ“¦ Install Node.js dependencies
        run: |
          npm --prefix frontend install
          
      - name: ðŸ”— Install Claude Flow (Global)
        run: |
          npm install -g claude-flow@alpha
          
      - name: ðŸ“Š Dependency report
        run: |
          echo "## ðŸ“¦ Dependency Installation Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Python: ${{ env.PYTHON_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- Node.js: ${{ env.NODE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- UV: ${{ env.UV_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dependencies changed: ${{ steps.deps-check.outputs.changed }}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # GIT HOOKS TESTING & VALIDATION
  # ============================================================================
  git-hooks-validation:
    name: ðŸ”— Git Hooks Testing & Validation
    runs-on: ubuntu-latest
    needs: setup-environment
    strategy:
      matrix:
        hook-phase:
          - functional
          - performance
          - integration
          
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ðŸ Setup Python with UV
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: âš¡ Install UV package manager
        run: |
          curl -LsSf https://astral.sh/uv/${{ env.UV_VERSION }}/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'
          
      - name: ðŸ“¦ Restore dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ~/.npm
            frontend/node_modules
            .venv
          key: ${{ needs.setup-environment.outputs.cache-key }}
          
      - name: ðŸ“¦ Install dependencies (if cache miss)
        run: |
          uv sync --dev --extra jupyter
          npm --prefix frontend install
          npm install -g claude-flow@alpha
          
      - name: ðŸ“ Create test output directories
        run: |
          mkdir -p .claude_workspace/reports/hook-tests/${{ matrix.hook-phase }}
          mkdir -p .claude_workspace/reports/screenshots
          mkdir -p .claude_workspace/reports/logs
          
      - name: ðŸ§ª Run hook validation tests
        id: hook-tests
        run: |
          echo "Running ${{ matrix.hook-phase }} hook validation tests..."
          
          # Set environment variables for test configuration
          export PARALLEL=${{ env.PARALLEL_EXECUTION }}
          export TIMEOUT=${{ env.HOOK_TIMEOUT }}
          export HOOK_TYPE="${{ github.event.inputs.hook_type || 'all' }}"
          export PERFORMANCE_MODE="${{ github.event.inputs.performance_mode || 'standard' }}"
          
          # Run specific hook phase tests
          case "${{ matrix.hook-phase }}" in
            "functional")
              make test-hooks-functional
              ;;
            "performance")
              if [[ "$PERFORMANCE_MODE" == "stress" ]]; then
                make test-hooks-stress
              else
                make test-hooks-performance
              fi
              ;;
            "integration")
              make test-hooks-integration
              ;;
          esac
          
      - name: ðŸ“Š Generate test metrics
        if: always()
        run: |
          echo "## ðŸ”— Hook Testing Results - ${{ matrix.hook-phase }}" >> $GITHUB_STEP_SUMMARY
          
          if [[ -f ".claude_workspace/reports/hook-tests/${{ matrix.hook-phase }}/results.json" ]]; then
            RESULTS=$(cat .claude_workspace/reports/hook-tests/${{ matrix.hook-phase }}/results.json)
            echo "### Test Summary" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            echo "$RESULTS" | jq '.' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: ðŸ“¤ Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hook-test-results-${{ matrix.hook-phase }}
          path: |
            .claude_workspace/reports/hook-tests/
            .claude_workspace/reports/screenshots/
            .claude_workspace/reports/logs/
          retention-days: 30

  # ============================================================================
  # PERFORMANCE MONITORING & BENCHMARKING
  # ============================================================================
  performance-monitoring:
    name: ðŸ“Š Performance Monitoring & Benchmarking
    runs-on: ubuntu-latest
    needs: [setup-environment, git-hooks-validation]
    if: github.event_name == 'push' || github.event_name == 'schedule'
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ðŸ Setup Python with UV
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: âš¡ Install UV package manager
        run: |
          curl -LsSf https://astral.sh/uv/${{ env.UV_VERSION }}/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'
          
      - name: ðŸ“¦ Restore dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ~/.npm
            frontend/node_modules
            .venv
          key: ${{ needs.setup-environment.outputs.cache-key }}
          
      - name: ðŸ“¦ Install dependencies (if cache miss)
        run: |
          uv sync --dev --extra jupyter
          npm --prefix frontend install
          npm install -g claude-flow@alpha
          
      - name: ðŸ“Š Run performance benchmarks
        id: benchmarks
        run: |
          echo "Running comprehensive performance benchmarks..."
          
          # Run full benchmark suite
          make benchmark
          
          # Generate performance baseline
          node tests/hooks/automation/hook-test-runner.js --timeout 600 --parallel performance
          
      - name: ðŸ“ˆ Analyze performance trends
        run: |
          echo "## ðŸ“Š Performance Benchmark Results" >> $GITHUB_STEP_SUMMARY
          
          # Extract key metrics
          if [[ -f ".claude_workspace/reports/hook-tests/performance/benchmark-summary.json" ]]; then
            METRICS=$(cat .claude_workspace/reports/hook-tests/performance/benchmark-summary.json)
            echo "### Performance Metrics" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            echo "$METRICS" | jq '.' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: ðŸ“¤ Upload performance data
        uses: actions/upload-artifact@v4
        with:
          name: performance-benchmarks-${{ github.sha }}
          path: |
            .claude_workspace/reports/hook-tests/performance/
            .claude_workspace/scripts/benchmark-results/
          retention-days: 90

  # ============================================================================
  # AUTOMATED DEPENDENCY UPDATES
  # ============================================================================
  dependency-updates:
    name: ðŸ”„ Automated Dependency Updates
    runs-on: ubuntu-latest
    needs: setup-environment
    if: needs.setup-environment.outputs.dependencies-changed == 'true'
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ðŸ Setup Python with UV
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: âš¡ Install UV package manager
        run: |
          curl -LsSf https://astral.sh/uv/${{ env.UV_VERSION }}/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'
          
      - name: ðŸ”„ Update Python dependencies
        run: |
          echo "Updating Python dependencies..."
          uv sync --upgrade
          
      - name: ðŸ”„ Update Node.js dependencies
        run: |
          echo "Updating Node.js dependencies..."
          npm --prefix frontend update
          
      - name: ðŸ§ª Run tests after updates
        run: |
          # Run quick validation tests
          make test
          make lint
          make typecheck
          
      - name: ðŸ“Š Generate dependency update report
        run: |
          echo "## ðŸ”„ Dependency Update Report" >> $GITHUB_STEP_SUMMARY
          echo "### Updated Dependencies" >> $GITHUB_STEP_SUMMARY
          
          # Check for changes in lock files
          if git diff --name-only | grep -E '(uv.lock|package-lock.json)'; then
            echo "- Dependencies were updated successfully" >> $GITHUB_STEP_SUMMARY
            git diff --stat >> $GITHUB_STEP_SUMMARY
          else
            echo "- No dependency updates were needed" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # DEVELOPMENT ENVIRONMENT HOOK INSTALLATION
  # ============================================================================
  hook-installation-test:
    name: ðŸ› ï¸ Hook Installation Testing
    runs-on: ubuntu-latest
    needs: setup-environment
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ðŸ Setup Python with UV
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: âš¡ Install UV package manager
        run: |
          curl -LsSf https://astral.sh/uv/${{ env.UV_VERSION }}/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'
          
      - name: ðŸ“¦ Restore dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ~/.npm
            frontend/node_modules
            .venv
          key: ${{ needs.setup-environment.outputs.cache-key }}
          
      - name: ðŸ“¦ Install dependencies (if cache miss)
        run: |
          uv sync --dev --extra jupyter
          npm --prefix frontend install
          npm install -g claude-flow@alpha
          
      - name: ðŸ”§ Test hook installation script
        run: |
          echo "Testing automated hook installation..."
          
          # Create and test hook installation script
          ./scripts/install-git-hooks.sh --test-mode
          
      - name: âœ… Validate hook installation
        run: |
          echo "Validating hook installation..."
          
          # Check if hooks are properly installed
          if [[ -x ".git/hooks/pre-commit" ]] && [[ -x ".git/hooks/post-commit" ]]; then
            echo "âœ… Git hooks installed successfully"
            echo "## ðŸ”§ Hook Installation Status" >> $GITHUB_STEP_SUMMARY
            echo "- Pre-commit hook: âœ… Installed" >> $GITHUB_STEP_SUMMARY
            echo "- Post-commit hook: âœ… Installed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Git hooks installation failed"
            echo "## ðŸ”§ Hook Installation Status" >> $GITHUB_STEP_SUMMARY
            echo "- Installation: âŒ Failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # ============================================================================
  # COMPREHENSIVE REPORTING
  # ============================================================================
  generate-comprehensive-report:
    name: ðŸ“‹ Generate Comprehensive Report
    runs-on: ubuntu-latest
    needs: [setup-environment, git-hooks-validation, performance-monitoring]
    if: always()
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ðŸ“¤ Download all test artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./test-artifacts
          
      - name: ðŸ“Š Generate comprehensive report
        run: |
          echo "Generating comprehensive Git hooks CI/CD report..."
          
          # Create comprehensive report directory
          mkdir -p .claude_workspace/reports/cicd
          
          # Generate HTML report combining all test results
          node tests/hooks/automation/hook-test-runner.js report \
            --output .claude_workspace/reports/cicd \
            --input-dir ./test-artifacts
            
      - name: ðŸ“‹ Create workflow summary
        run: |
          echo "## ðŸ”— Git Hooks CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "### Workflow Execution Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ runner.os }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Test Phase Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Functional Tests**: ${{ needs.git-hooks-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Performance Monitoring**: ${{ needs.performance-monitoring.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Hook Installation**: ${{ needs.hook-installation-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.git-hooks-validation.result }}" == "success" ]] && \
             [[ "${{ needs.performance-monitoring.result }}" == "success" ]]; then
            echo "âœ… All tests passed! Git hooks are ready for production deployment." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Some tests failed. Please review the detailed reports above." >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: ðŸ“¤ Upload comprehensive report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: comprehensive-report-${{ github.sha }}
          path: |
            .claude_workspace/reports/cicd/
            ./test-artifacts/
          retention-days: 30

  # ============================================================================
  # DEPLOYMENT & AUTOMATION
  # ============================================================================
  deploy-hooks:
    name: ðŸš€ Deploy Git Hooks
    runs-on: ubuntu-latest
    needs: [git-hooks-validation, performance-monitoring, hook-installation-test]
    if: |
      github.event_name == 'push' && 
      github.ref == 'refs/heads/main' &&
      needs.git-hooks-validation.result == 'success' &&
      needs.performance-monitoring.result == 'success'
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ðŸš€ Deploy production hooks
        run: |
          echo "ðŸš€ Deploying Git hooks to production..."
          
          # This step would deploy hooks to production environments
          # For now, we'll just validate the deployment readiness
          
          echo "## ðŸš€ Production Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Ready for deployment" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment time**: $(date)" >> $GITHUB_STEP_SUMMARY
          
      - name: ðŸ“Š Post-deployment validation
        run: |
          echo "Running post-deployment validation..."
          
          # Quick validation that everything is working
          echo "âœ… Post-deployment validation completed"