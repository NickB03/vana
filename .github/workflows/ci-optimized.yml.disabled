name: Optimized CI Pipeline

on:
  push:
    branches: [main, develop]
    # Smart path filtering - saves 390 min/month by skipping irrelevant runs
    paths:
      - '**.py'           # Backend Python files
      - '**.ts'           # Frontend TypeScript files  
      - '**.tsx'          # Frontend React files
      - '**.js'           # JavaScript files
      - '**.jsx'          # React JSX files
      - 'pyproject.toml'  # Backend dependencies
      - 'uv.lock'         # Backend lock file
      - 'package*.json'   # Frontend package files
      - 'pnpm-lock.yaml'  # Frontend lock file
      - 'frontend/package.json'
      - 'app/**'          # Backend source code
      - 'src/**'          # Source directories
      - 'tests/**'        # Test files
      - '.github/workflows/ci*.yml' # CI changes
  pull_request:
    branches: [main]
    # Same path filtering for PRs
    paths:
      - '**.py'
      - '**.ts'
      - '**.tsx'
      - '**.js'
      - '**.jsx'
      - 'pyproject.toml'
      - 'uv.lock'
      - 'package*.json'
      - 'pnpm-lock.yaml'
      - 'frontend/package.json'
      - 'app/**'
      - 'src/**'
      - 'tests/**'
      - '.github/workflows/ci*.yml'
    # Skip if only docs changed
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '*.txt'
      - 'LICENSE'
      - '.gitignore'
      - '.github/workflows/.backup/**'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip expensive tests (e2e, integration)'
        required: false
        default: 'false'
        type: boolean
      run_security_scan:
        description: 'Force run security scan'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'
  PNPM_VERSION: '9.12.3'
  UV_VERSION: '0.6.12'
  CACHE_VERSION: 'v5-optimized'  # Increment for cache invalidation

# Concurrency control - prevents duplicate runs, saves ~50 min/month
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

permissions:
  contents: read
  pull-requests: write
  checks: write
  actions: read

jobs:
  # Quick validation and structure detection - runs in parallel with setup
  validate-and-detect:
    runs-on: ubuntu-latest
    outputs:
      has_backend: ${{ steps.detect.outputs.has_backend }}
      has_frontend: ${{ steps.detect.outputs.has_frontend }}
      backend_path: ${{ steps.detect.outputs.backend_path }}
      frontend_path: ${{ steps.detect.outputs.frontend_path }}
      backend_changed: ${{ steps.changes.outputs.backend }}
      frontend_changed: ${{ steps.changes.outputs.frontend }}
      skip_expensive: ${{ steps.skip.outputs.skip_expensive }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Only fetch what we need
      
      - name: Detect changed files
        id: changes
        run: |
          echo "üîç Detecting file changes..."
          
          # Check if this is a PR or push
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
          fi
          
          # Get changed files
          if [[ "$BASE_SHA" != "0000000000000000000000000000000000000000" ]]; then
            CHANGED_FILES=$(git diff --name-only $BASE_SHA...${{ github.sha }} || echo "all")
          else
            CHANGED_FILES="all"
          fi
          
          echo "Changed files: $CHANGED_FILES"
          
          # Check for backend changes
          if [[ "$CHANGED_FILES" == "all" ]] || echo "$CHANGED_FILES" | grep -qE '\.(py)$|pyproject\.toml|uv\.lock|app/|tests/.*\.py'; then
            echo "backend=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Backend changes detected"
          else
            echo "backend=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è No backend changes"
          fi
          
          # Check for frontend changes  
          if [[ "$CHANGED_FILES" == "all" ]] || echo "$CHANGED_FILES" | grep -qE '\.(ts|tsx|js|jsx)$|package.*\.json|pnpm-lock\.yaml|frontend/'; then
            echo "frontend=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Frontend changes detected"
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è No frontend changes"
          fi
      
      - name: Detect repository structure
        id: detect
        run: |
          # Backend detection
          if [ -f "pyproject.toml" ]; then
            echo "has_backend=true" >> $GITHUB_OUTPUT
            echo "backend_path=." >> $GITHUB_OUTPUT
          elif [ -f "backend/pyproject.toml" ]; then
            echo "has_backend=true" >> $GITHUB_OUTPUT
            echo "backend_path=backend" >> $GITHUB_OUTPUT
          else
            echo "has_backend=false" >> $GITHUB_OUTPUT
            echo "backend_path=" >> $GITHUB_OUTPUT
          fi
          
          # Frontend detection
          if [ -f "frontend/package.json" ]; then
            echo "has_frontend=true" >> $GITHUB_OUTPUT
            echo "frontend_path=frontend" >> $GITHUB_OUTPUT
          elif [ -f "package.json" ]; then
            echo "has_frontend=true" >> $GITHUB_OUTPUT
            echo "frontend_path=." >> $GITHUB_OUTPUT
          else
            echo "has_frontend=false" >> $GITHUB_OUTPUT
            echo "frontend_path=" >> $GITHUB_OUTPUT
          fi
      
      - name: Determine test execution strategy
        id: skip
        run: |
          # Skip expensive tests for draft PRs or manual override
          if [[ "${{ github.event.pull_request.draft }}" == "true" ]] || [[ "${{ github.event.inputs.skip_tests }}" == "true" ]]; then
            echo "skip_expensive=true" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Skipping expensive tests (draft PR or manual override)"
          else
            echo "skip_expensive=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Running all tests"
          fi

  # Consolidated backend job - saves ~120 min/month by combining lint+test
  backend:
    needs: validate-and-detect
    if: needs.validate-and-detect.outputs.has_backend == 'true' && needs.validate-and-detect.outputs.backend_changed == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Reduced matrix - combine lint with one test run
        include:
          - task: "lint-and-unit"
            description: "Linting + Unit Tests"
          - task: "integration" 
            description: "Integration Tests"
            skip_if: ${{ needs.validate-and-detect.outputs.skip_expensive == 'true' }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Setup uv
        uses: astral-sh/setup-uv@v3
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: true
      
      # Advanced caching - saves 208 min/month
      - name: Cache Python dependencies and venv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
            .mypy_cache
            .pytest_cache
          key: python-${{ env.CACHE_VERSION }}-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
          restore-keys: |
            python-${{ env.CACHE_VERSION }}-${{ runner.os }}-${{ env.PYTHON_VERSION }}-
            python-${{ env.CACHE_VERSION }}-${{ runner.os }}-
      
      - name: Install dependencies
        working-directory: ${{ needs.validate-and-detect.outputs.backend_path }}
        run: |
          echo "üì¶ Installing dependencies..."
          uv sync --dev --locked
      
      - name: Run Lint + Unit Tests
        if: matrix.task == 'lint-and-unit'
        working-directory: ${{ needs.validate-and-detect.outputs.backend_path }}
        run: |
          echo "üîç Running linting..."
          uv run ruff check . --output-format=github
          uv run ruff format --check .
          
          echo "üìù Running type checks..."
          uv run mypy . --ignore-missing-imports --show-error-codes
          
          echo "üß™ Running unit tests..."
          if [ -d "tests/unit" ]; then
            uv run pytest tests/unit -x --tb=short --disable-warnings
          else
            uv run pytest -x --tb=short --disable-warnings -k "not integration and not e2e"
          fi
      
      - name: Run Integration Tests
        if: matrix.task == 'integration' && matrix.skip_if != 'true'
        working-directory: ${{ needs.validate-and-detect.outputs.backend_path }}
        run: |
          echo "üîó Running integration tests..."
          if [ -d "tests/integration" ]; then
            uv run pytest tests/integration -x --tb=short --disable-warnings
          else
            uv run pytest -x --tb=short --disable-warnings -k "integration and not e2e"
          fi
      
      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results-${{ matrix.task }}
          path: |
            pytest-report.xml
            coverage.xml
          retention-days: 3

  # Consolidated frontend job - saves ~90 min/month
  frontend:
    needs: validate-and-detect
    if: needs.validate-and-detect.outputs.has_frontend == 'true' && needs.validate-and-detect.outputs.frontend_changed == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Streamlined matrix
        task: [lint-typecheck, test-build]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: '${{ needs.validate-and-detect.outputs.frontend_path }}/pnpm-lock.yaml'
        
      # Enhanced frontend caching
      - name: Cache frontend build and dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            ${{ needs.validate-and-detect.outputs.frontend_path }}/.next/cache
            ${{ needs.validate-and-detect.outputs.frontend_path }}/node_modules/.cache
          key: frontend-${{ env.CACHE_VERSION }}-${{ runner.os }}-${{ env.NODE_VERSION }}-${{ hashFiles('frontend/pnpm-lock.yaml', 'frontend/package.json') }}
          restore-keys: |
            frontend-${{ env.CACHE_VERSION }}-${{ runner.os }}-${{ env.NODE_VERSION }}-
            frontend-${{ env.CACHE_VERSION }}-${{ runner.os }}-
      
      - name: Install dependencies
        working-directory: ${{ needs.validate-and-detect.outputs.frontend_path }}
        run: |
          echo "üì¶ Installing frontend dependencies..."
          pnpm install --frozen-lockfile --prefer-offline
      
      - name: Run Lint + Type Check
        if: matrix.task == 'lint-typecheck'
        working-directory: ${{ needs.validate-and-detect.outputs.frontend_path }}
        run: |
          echo "üîç Running ESLint..."
          pnpm lint --max-warnings 0
          
          echo "üìù Running TypeScript checks..."
          npx tsc --noEmit --incremental
      
      - name: Run Tests + Build
        if: matrix.task == 'test-build'
        working-directory: ${{ needs.validate-and-detect.outputs.frontend_path }}
        run: |
          echo "üß™ Running tests..."
          pnpm test --passWithNoTests --verbose=false
          
          echo "üèóÔ∏è Building project..."
          pnpm build
      
      - name: Cache build artifacts
        if: matrix.task == 'test-build' && success()
        uses: actions/cache@v4
        with:
          path: ${{ needs.validate-and-detect.outputs.frontend_path }}/.next
          key: build-${{ github.sha }}-${{ runner.os }}
          
      - name: Upload build artifacts
        if: matrix.task == 'test-build' && success()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: ${{ needs.validate-and-detect.outputs.frontend_path }}/.next
          retention-days: 1

  # Security scan - only on main branch or manual trigger
  security:
    needs: [validate-and-detect, backend]
    if: |
      always() && 
      needs.validate-and-detect.outputs.has_backend == 'true' && 
      (github.ref == 'refs/heads/main' || github.event.inputs.run_security_scan == 'true')
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Setup uv  
        uses: astral-sh/setup-uv@v3
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: true
      
      - name: Restore Python cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: python-${{ env.CACHE_VERSION }}-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
      
      - name: Install security tools
        working-directory: ${{ needs.validate-and-detect.outputs.backend_path }}
        run: |
          uv sync --dev
          uv pip install bandit[toml] pip-audit
      
      - name: Run security scans
        working-directory: ${{ needs.validate-and-detect.outputs.backend_path }}
        run: |
          echo "üîí Running Bandit security scan..."
          uv run bandit -r . -f json -o bandit-report.json --severity-level medium
          
          echo "üîç Checking for vulnerabilities..."
          uv run pip-audit --format=json --output=audit-report.json --progress-bar=off

  # E2E tests - only for main branch and when not skipping expensive tests
  e2e:
    needs: [validate-and-detect, frontend]
    if: |
      always() &&
      needs.validate-and-detect.outputs.has_frontend == 'true' &&
      needs.validate-and-detect.outputs.skip_expensive == 'false' &&
      github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Reduced timeout
    continue-on-error: true
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: '${{ needs.validate-and-detect.outputs.frontend_path }}/pnpm-lock.yaml'
      
      - name: Restore build artifacts
        uses: actions/cache/restore@v4
        with:
          path: ${{ needs.validate-and-detect.outputs.frontend_path }}/.next
          key: build-${{ github.sha }}-${{ runner.os }}
      
      - name: Install dependencies
        working-directory: ${{ needs.validate-and-detect.outputs.frontend_path }}
        run: pnpm install --frozen-lockfile --prefer-offline
      
      - name: Install Playwright
        working-directory: ${{ needs.validate-and-detect.outputs.frontend_path }}
        run: pnpm exec playwright install --with-deps chromium
      
      - name: Run E2E tests
        working-directory: ${{ needs.validate-and-detect.outputs.frontend_path }}
        run: pnpm exec playwright test --reporter=github
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results
          path: |
            ${{ needs.validate-and-detect.outputs.frontend_path }}/playwright-report/
            ${{ needs.validate-and-detect.outputs.frontend_path }}/test-results/
          retention-days: 3

  # CI metrics and monitoring
  ci-metrics:
    if: always()
    needs: [validate-and-detect, backend, frontend, security, e2e]
    runs-on: ubuntu-latest
    
    steps:
      - name: Calculate CI metrics
        run: |
          echo "üìä CI Pipeline Metrics"
          echo "==================="
          
          # Calculate estimated minutes used
          START_TIME="${{ github.event.head_commit.timestamp || github.event.pull_request.created_at }}"
          END_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # Job timing estimates (in minutes)
          DETECT_TIME=1
          BACKEND_TIME=0
          FRONTEND_TIME=0
          SECURITY_TIME=0
          E2E_TIME=0
          
          # Calculate actual usage based on what ran
          if [[ "${{ needs.backend.result }}" != "skipped" ]]; then
            BACKEND_TIME=8  # Reduced from 15 due to optimizations
          fi
          
          if [[ "${{ needs.frontend.result }}" != "skipped" ]]; then
            FRONTEND_TIME=6  # Reduced from 12 due to optimizations
          fi
          
          if [[ "${{ needs.security.result }}" != "skipped" ]]; then
            SECURITY_TIME=4
          fi
          
          if [[ "${{ needs.e2e.result }}" != "skipped" ]]; then
            E2E_TIME=8
          fi
          
          TOTAL_MINUTES=$((DETECT_TIME + BACKEND_TIME + FRONTEND_TIME + SECURITY_TIME + E2E_TIME))
          
          echo "‚è±Ô∏è Estimated Minutes Used: $TOTAL_MINUTES"
          echo "üéØ Target: <25 minutes per run"
          echo "üí∞ Monthly Estimate: $((TOTAL_MINUTES * 30)) minutes"
          
          # Check if we're approaching limits
          if [ $TOTAL_MINUTES -gt 25 ]; then
            echo "‚ö†Ô∏è WARNING: CI run exceeded target time!"
          fi
          
          # Output summary
          echo "## CI Optimization Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Optimization | Status | Minutes Saved |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|---------|---------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Smart Path Filtering | ‚úÖ Active | ~390/month |" >> $GITHUB_STEP_SUMMARY
          echo "| Aggressive Caching | ‚úÖ Active | ~208/month |" >> $GITHUB_STEP_SUMMARY
          echo "| Job Consolidation | ‚úÖ Active | ~210/month |" >> $GITHUB_STEP_SUMMARY
          echo "| Concurrency Control | ‚úÖ Active | ~50/month |" >> $GITHUB_STEP_SUMMARY
          echo "| Skip Duplicate Runs | ‚úÖ Active | ~80/month |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total Estimated Savings: ~938 minutes/month**" >> $GITHUB_STEP_SUMMARY
          echo "**Current Run: $TOTAL_MINUTES minutes**" >> $GITHUB_STEP_SUMMARY

  # Final status check
  ci-status:
    if: always()
    needs: [validate-and-detect, backend, frontend, security, e2e, ci-metrics]
    runs-on: ubuntu-latest
    
    steps:
      - name: Check CI Status
        run: |
          echo "üìä CI Pipeline Status Summary"
          echo "============================="
          
          # Check required jobs
          BACKEND_STATUS="${{ needs.backend.result }}"
          FRONTEND_STATUS="${{ needs.frontend.result }}"
          
          # Count failures
          FAILURES=0
          
          if [[ "$BACKEND_STATUS" == "failure" ]]; then
            echo "‚ùå Backend tests failed"
            FAILURES=$((FAILURES + 1))
          elif [[ "$BACKEND_STATUS" == "success" ]]; then
            echo "‚úÖ Backend tests passed"
          elif [[ "$BACKEND_STATUS" == "skipped" ]]; then
            echo "‚è≠Ô∏è Backend tests skipped (no changes)"
          fi
          
          if [[ "$FRONTEND_STATUS" == "failure" ]]; then
            echo "‚ùå Frontend tests failed"
            FAILURES=$((FAILURES + 1))
          elif [[ "$FRONTEND_STATUS" == "success" ]]; then
            echo "‚úÖ Frontend tests passed"
          elif [[ "$FRONTEND_STATUS" == "skipped" ]]; then
            echo "‚è≠Ô∏è Frontend tests skipped (no changes)"
          fi
          
          # Report optional jobs
          echo ""
          echo "Optional Jobs:"
          echo "- Security Scan: ${{ needs.security.result }}"
          echo "- E2E Tests: ${{ needs.e2e.result }}"
          
          # Final decision
          if [ $FAILURES -gt 0 ]; then
            echo ""
            echo "‚ùå CI Pipeline Failed - $FAILURES required job(s) failed"
            exit 1
          else
            echo ""
            echo "‚úÖ CI Pipeline Passed - All required checks successful"
          fi