name: Optimized CI/CD Pipeline

on:
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'Environment to deploy to'
        required: false
        default: 'none'
        type: choice
        options:
          - none
          - staging
          - production
      force_rebuild:
        description: 'Force rebuild without cache'
        required: false
        default: false
        type: boolean
  push:
    branches: [main, develop, 'release/*']
  pull_request_target:
    branches: [main]
    types: [opened, synchronize, reopened]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'
  UV_VERSION: '0.6.12'

jobs:
  # Security gate for fork PRs with enhanced checks
  security_gate:
    name: ğŸ›¡ï¸ Security Gate
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_target'
    outputs:
      approved: ${{ steps.security_check.outputs.approved }}
      pr_safe: ${{ steps.pr_analysis.outputs.safe }}
    steps:
      - name: Security Check for Fork PRs
        id: security_check
        run: |
          if [[ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]]; then
            echo "::warning::Fork PR detected from ${{ github.event.pull_request.head.repo.full_name }}"
            echo "approved=false" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "approved=true" >> $GITHUB_OUTPUT
          fi

      - name: PR Analysis
        id: pr_analysis
        if: steps.security_check.outputs.approved == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 100

      - name: Check for sensitive file changes
        if: steps.security_check.outputs.approved == 'true'
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD~1)
          SENSITIVE_PATTERNS=".env|secret|key|password|token|credential"
          
          if echo "$CHANGED_FILES" | grep -iE "$SENSITIVE_PATTERNS"; then
            echo "::warning::Sensitive files detected in PR"
            echo "safe=false" >> $GITHUB_OUTPUT
          else
            echo "safe=true" >> $GITHUB_OUTPUT
          fi

  # Dependency and build cache management
  setup_cache:
    name: ğŸ“¦ Setup Dependencies & Cache
    runs-on: self-hosted
    needs: [security_gate]
    if: always() && (needs.security_gate.outputs.approved == 'true' || github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    outputs:
      cache_hit_uv: ${{ steps.cache_uv.outputs.cache-hit }}
      cache_hit_npm: ${{ steps.cache_npm.outputs.cache-hit }}
      python_deps_hash: ${{ steps.hash_deps.outputs.python }}
      node_deps_hash: ${{ steps.hash_deps.outputs.node }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}

      - name: Generate Dependency Hashes
        id: hash_deps
        run: |
          echo "python=$(sha256sum pyproject.toml uv.lock | sha256sum | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "node=$(sha256sum package.json frontend/package.json frontend/package-lock.json | sha256sum | cut -d' ' -f1)" >> $GITHUB_OUTPUT

      - name: Cache UV Dependencies
        id: cache_uv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ steps.hash_deps.outputs.python }}
          restore-keys: |
            uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-

      - name: Cache NPM Dependencies
        id: cache_npm
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            frontend/node_modules
            frontend/.next/cache
          key: npm-${{ runner.os }}-${{ env.NODE_VERSION }}-${{ steps.hash_deps.outputs.node }}
          restore-keys: |
            npm-${{ runner.os }}-${{ env.NODE_VERSION }}-

      - name: Install UV if not cached
        if: steps.cache_uv.outputs.cache-hit != 'true' || github.event.inputs.force_rebuild == 'true'
        run: |
          curl -LsSf https://astral.sh/uv/${{ env.UV_VERSION }}/install.sh | sh
          source $HOME/.local/bin/env
          uv sync --dev --extra jupyter

      - name: Install NPM dependencies if not cached
        if: steps.cache_npm.outputs.cache-hit != 'true' || github.event.inputs.force_rebuild == 'true'
        run: |
          npm --prefix frontend install

  # Parallel testing strategy
  test_matrix:
    name: ğŸ§ª Tests (${{ matrix.test_type }})
    runs-on: self-hosted
    needs: [security_gate, setup_cache]
    if: always() && (needs.security_gate.outputs.approved == 'true' || github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        test_type: [unit, integration, performance]
        include:
          - test_type: unit
            command: make test-unit
            artifact: unit-test-results
          - test_type: integration  
            command: make test-integration
            artifact: integration-test-results
          - test_type: performance
            command: make test-performance
            artifact: performance-test-results
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}

      - name: Restore UV Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ needs.setup_cache.outputs.python_deps_hash }}

      - name: Setup Environment
        run: |
          source $HOME/.local/bin/env || true
          export PATH="$HOME/.local/bin:$PATH"

      - name: Run ${{ matrix.test_type }} Tests
        run: |
          echo "ğŸ§ª Running ${{ matrix.test_type }} tests..."
          ${{ matrix.command }}
        env:
          PYTEST_XDIST_WORKER_COUNT: 4

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ${{ matrix.artifact }}
          path: |
            pytest-report.xml
            .coverage*
            htmlcov/
          retention-days: 30

  # Quality checks in parallel
  quality_checks:
    name: ğŸ” Quality Checks (${{ matrix.check_type }})
    runs-on: self-hosted
    needs: [security_gate, setup_cache]
    if: always() && (needs.security_gate.outputs.approved == 'true' || github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        check_type: [lint, typecheck, format]
        include:
          - check_type: lint
            command: make lint
          - check_type: typecheck
            command: make typecheck
          - check_type: format
            command: uv run ruff format . --check
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}

      - name: Restore UV Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ needs.setup_cache.outputs.python_deps_hash }}

      - name: Setup Environment
        run: |
          source $HOME/.local/bin/env || true
          export PATH="$HOME/.local/bin:$PATH"

      - name: Run ${{ matrix.check_type }}
        run: |
          echo "ğŸ” Running ${{ matrix.check_type }}..."
          ${{ matrix.command }}

  # Security scanning
  security_scan:
    name: ğŸ”’ Security Scanning
    runs-on: self-hosted
    needs: [security_gate, setup_cache]
    if: always() && (needs.security_gate.outputs.approved == 'true' || github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    timeout-minutes: 15
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}

      - name: Restore UV Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ needs.setup_cache.outputs.python_deps_hash }}

      - name: Run Security Checks
        run: |
          source $HOME/.local/bin/env || true
          export PATH="$HOME/.local/bin:$PATH"
          
          echo "ğŸ”’ Running dependency vulnerability scan..."
          uv run safety check --json --output security-report.json || true
          
          echo "ğŸ” Running bandit security scan..."
          uv run bandit -r app/ -f json -o bandit-report.json || true
          
          echo "ğŸ” Scanning for secrets..."
          # Basic secret detection (can be enhanced with specialized tools)
          grep -r -E "(password|secret|key|token).*=.*['\"][^'\"]*['\"]" app/ || echo "No obvious secrets found"

      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            security-report.json
            bandit-report.json
          retention-days: 90

  # Build and package
  build:
    name: ğŸ—ï¸ Build & Package
    runs-on: self-hosted
    needs: [security_gate, setup_cache, test_matrix, quality_checks]
    if: always() && needs.test_matrix.result == 'success' && needs.quality_checks.result == 'success'
    timeout-minutes: 15
    outputs:
      image_digest: ${{ steps.build_image.outputs.digest }}
      image_tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}

      - name: Restore Caches
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: uv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ needs.setup_cache.outputs.python_deps_hash }}

      - name: Build Frontend
        run: |
          npm --prefix frontend run build

      - name: Docker Meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build Docker Image
        id: build_image
        run: |
          docker build \
            --build-arg COMMIT_SHA=${{ github.sha }} \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --file Dockerfile \
            .
          
          echo "digest=sha256:$(docker images --digests ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} --format '{{.Digest}}' | cut -d: -f2)" >> $GITHUB_OUTPUT

      - name: Test Image
        run: |
          echo "ğŸ§ª Testing built image..."
          docker run --rm -d --name test-container -p 8080:8080 ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          sleep 10
          curl -f http://localhost:8080/health || exit 1
          docker stop test-container

  # Deployment jobs (conditional)
  deploy_staging:
    name: ğŸš€ Deploy to Staging
    runs-on: self-hosted
    needs: [build, security_scan]
    if: |
      always() && 
      needs.build.result == 'success' && 
      (github.ref == 'refs/heads/develop' || 
       github.event.inputs.deploy_environment == 'staging')
    environment: staging
    timeout-minutes: 10
    steps:
      - name: Deploy to Staging
        run: |
          echo "ğŸš€ Deploying to staging environment..."
          # Add your staging deployment logic here
          # docker-compose -f docker-compose.staging.yml up -d --force-recreate

      - name: Health Check
        run: |
          echo "ğŸ¥ Running health checks..."
          # Add health check logic

      - name: Smoke Tests
        run: |
          echo "ğŸ’¨ Running smoke tests..."
          # Add smoke test logic

  deploy_production:
    name: ğŸ¯ Deploy to Production
    runs-on: self-hosted
    needs: [build, security_scan]
    if: |
      always() && 
      needs.build.result == 'success' && 
      needs.security_scan.result == 'success' &&
      (github.ref == 'refs/heads/main' || 
       github.event.inputs.deploy_environment == 'production')
    environment: production
    timeout-minutes: 15
    steps:
      - name: Blue-Green Deployment
        run: |
          echo "ğŸ”„ Starting blue-green deployment..."
          # Add blue-green deployment logic

      - name: Health Check & Rollback
        run: |
          echo "ğŸ¥ Running production health checks..."
          # Add health check and rollback logic

  # Notification and reporting
  notify:
    name: ğŸ“Š Notifications & Reporting
    runs-on: self-hosted
    needs: [test_matrix, quality_checks, security_scan, build]
    if: always()
    steps:
      - name: Generate Pipeline Report
        run: |
          echo "ğŸ“Š Generating pipeline report..."
          echo "Tests: ${{ needs.test_matrix.result }}"
          echo "Quality: ${{ needs.quality_checks.result }}"
          echo "Security: ${{ needs.security_scan.result }}"
          echo "Build: ${{ needs.build.result }}"

      - name: Performance Metrics
        run: |
          echo "âš¡ Pipeline Performance:"
          echo "Total Duration: ${{ github.run_duration }}"
          # Add more metrics collection

      - name: Update Status
        if: always()
        run: |
          if [[ "${{ needs.test_matrix.result }}" == "success" && "${{ needs.quality_checks.result }}" == "success" ]]; then
            echo "âœ… Pipeline completed successfully"
          else
            echo "âŒ Pipeline failed"
            exit 1
          fi