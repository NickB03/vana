name: Security Scan

on:
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Mondays at 2 AM
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'app/**'
      - 'pyproject.toml'
      - 'uv.lock'

env:
  PYTHON_VERSION: '3.11'
  UV_VERSION: '0.6.12'
  CACHE_VERSION: 'v4'

permissions:
  contents: read

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup uv
        uses: astral-sh/setup-uv@v3
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: true
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: security-${{ env.CACHE_VERSION }}-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
          restore-keys: |
            security-${{ env.CACHE_VERSION }}-${{ runner.os }}-${{ env.PYTHON_VERSION }}-

      - name: Install dependencies and security tools
        run: |
          uv sync --dev
          uv pip install bandit[toml] pip-audit

      - name: Run security checks
        run: |
          set +e  # Allow commands to fail without stopping the workflow
          
          echo "::group::Bandit Security Scan"
          uv run bandit -r app/ -ll --format=txt
          bandit_exit_code=$?
          uv run bandit -r app/ -ll --format=json -o bandit-report.json || true
          if [ $bandit_exit_code -ne 0 ]; then
            echo "::warning::Bandit found security issues (exit code: $bandit_exit_code)"
          else
            echo "✅ No high/medium security issues found"
          fi
          echo "::endgroup::"
          
          echo "::group::pip-audit Vulnerability Check"
          # Ignore known false positives and non-critical vulnerabilities
          uv run pip-audit \
            --timeout=120 \
            --ignore-vuln=GHSA-wj6h-64fc-37mp \
            --ignore-vuln=GHSA-2c2j-9gv5-cj73 \
            --ignore-vuln=GHSA-887c-mr87-cxwp \
            --format=json --output=audit-report.json
          audit_exit_code=$?
          uv run pip-audit \
            --timeout=120 \
            --ignore-vuln=GHSA-wj6h-64fc-37mp \
            --ignore-vuln=GHSA-2c2j-9gv5-cj73 \
            --ignore-vuln=GHSA-887c-mr87-cxwp || true
          if [ $audit_exit_code -ne 0 ]; then
            echo "::warning::pip-audit found vulnerabilities (exit code: $audit_exit_code)"
          else
            echo "✅ No critical vulnerabilities found"
          fi
          echo "::endgroup::"
          
          # Set overall result (workflow passes even with warnings)
          echo "Security scan completed with warnings documented in artifacts"

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports-${{ github.sha }}
          path: |
            bandit-report.json
            audit-report.json
          retention-days: 7
      
      - name: Generate security summary
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Bandit scan**: $(uv run bandit -r app/ -ll --format=txt > /dev/null 2>&1 && echo '✅ No HIGH/MEDIUM issues' || echo '⚠️ Issues found (see artifacts)')" >> $GITHUB_STEP_SUMMARY
          echo "- **pip-audit check**: $(uv run pip-audit --timeout=60 --ignore-vuln=GHSA-wj6h-64fc-37mp --ignore-vuln=GHSA-2c2j-9gv5-cj73 --ignore-vuln=GHSA-887c-mr87-cxwp --quiet > /dev/null 2>&1 && echo '✅ No critical vulnerabilities' || echo '⚠️ Vulnerabilities found (see artifacts)')" >> $GITHUB_STEP_SUMMARY
          echo "- **Ignored vulns**: GHSA-wj6h-64fc-37mp (ecdsa), GHSA-2c2j-9gv5-cj73 (starlette), GHSA-887c-mr87-cxwp (torch)" >> $GITHUB_STEP_SUMMARY
          echo "- **Files scanned**: $(find app/ -name '*.py' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- **Reports uploaded**: ✅ Available as workflow artifacts" >> $GITHUB_STEP_SUMMARY