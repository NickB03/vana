-- Fix app_settings RLS vulnerability
--
-- SECURITY ISSUE: Previous policies used user_metadata which is INSECURE
-- because users can edit their own user_metadata via Supabase API.
--
-- FIX: Remove user_metadata checks and use only email allowlist.
-- Admin emails are stored in auth.jwt() ->> 'email' which is server-controlled
-- and cannot be modified by users.
--
-- IDEMPOTENT: Safe to run multiple times

-- Drop and recreate the vulnerable UPDATE policy
DO $$
BEGIN
  DROP POLICY IF EXISTS "Only admins can update app settings" ON app_settings;

  CREATE POLICY "Only admins can update app settings"
    ON app_settings FOR UPDATE
    USING (
      auth.uid() IS NOT NULL AND
      auth.jwt() ->> 'email' = 'nick@vana.bot'
    )
    WITH CHECK (
      auth.uid() IS NOT NULL AND
      auth.jwt() ->> 'email' = 'nick@vana.bot'
    );

EXCEPTION WHEN duplicate_object THEN NULL;
END $$;

-- Drop and recreate the vulnerable INSERT policy
DO $$
BEGIN
  DROP POLICY IF EXISTS "Only admins can insert app settings" ON app_settings;

  CREATE POLICY "Only admins can insert app settings"
    ON app_settings FOR INSERT
    WITH CHECK (
      auth.uid() IS NOT NULL AND
      auth.jwt() ->> 'email' = 'nick@vana.bot'
    );

EXCEPTION WHEN duplicate_object THEN NULL;
END $$;

-- Also fix the SECURITY DEFINER function which had the same vulnerability
CREATE OR REPLACE FUNCTION update_app_setting(
  setting_key TEXT,
  setting_value JSONB
)
RETURNS app_settings
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_temp
AS $$
DECLARE
  result app_settings;
BEGIN
  -- Check if user is authenticated
  IF auth.uid() IS NULL THEN
    RAISE EXCEPTION 'Authentication required to update app settings';
  END IF;

  -- Check if user is in admin allowlist (email-based, secure)
  IF COALESCE(auth.jwt() ->> 'email', '') != 'nick@vana.bot' THEN
    RAISE EXCEPTION 'Only admins can update app settings. User: %',
      COALESCE(auth.jwt() ->> 'email', 'unknown');
  END IF;

  -- Update the setting
  UPDATE app_settings
  SET
    value = setting_value,
    updated_by = auth.uid(),
    updated_at = now()
  WHERE key = setting_key
  RETURNING * INTO result;

  IF result IS NULL THEN
    RAISE EXCEPTION 'Setting not found: %', setting_key;
  END IF;

  RETURN result;
END;
$$;

-- Add comment explaining the security model
COMMENT ON FUNCTION update_app_setting IS 'Updates app settings with admin authorization. Uses email allowlist (secure) instead of user_metadata (insecure).';

-- Add security note to table comment
COMMENT ON TABLE app_settings IS 'Global application settings that affect all users. Admin access controlled via email allowlist in RLS policies. DO NOT use user_metadata for authorization (users can edit it).';
